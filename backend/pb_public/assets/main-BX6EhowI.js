(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();class b extends Error{constructor(e){var t,s,i,o;super("ClientResponseError"),this.url="",this.status=0,this.response={},this.isAbort=!1,this.originalError=null,Object.setPrototypeOf(this,b.prototype),e!==null&&typeof e=="object"&&(this.url=typeof e.url=="string"?e.url:"",this.status=typeof e.status=="number"?e.status:0,this.isAbort=!!e.isAbort,this.originalError=e.originalError,e.response!==null&&typeof e.response=="object"?this.response=e.response:e.data!==null&&typeof e.data=="object"?this.response=e.data:this.response={}),this.originalError||e instanceof b||(this.originalError=e),typeof DOMException<"u"&&e instanceof DOMException&&(this.isAbort=!0),this.name="ClientResponseError "+this.status,this.message=(t=this.response)==null?void 0:t.message,this.message||(this.isAbort?this.message="The request was autocancelled. You can find more info in https://github.com/pocketbase/js-sdk#auto-cancellation.":(o=(i=(s=this.originalError)==null?void 0:s.cause)==null?void 0:i.message)!=null&&o.includes("ECONNREFUSED ::1")?this.message="Failed to connect to the PocketBase server. Try changing the SDK URL from localhost to 127.0.0.1 (https://github.com/pocketbase/js-sdk/issues/21).":this.message="Something went wrong while processing your request.")}get data(){return this.response}toJSON(){return{...this}}}const A=/^[\u0009\u0020-\u007e\u0080-\u00ff]+$/;function V(c,e){const t={};if(typeof c!="string")return t;const s=Object.assign({},{}).decode||J;let i=0;for(;i<c.length;){const o=c.indexOf("=",i);if(o===-1)break;let n=c.indexOf(";",i);if(n===-1)n=c.length;else if(n<o){i=c.lastIndexOf(";",o-1)+1;continue}const r=c.slice(i,o).trim();if(t[r]===void 0){let a=c.slice(o+1,n).trim();a.charCodeAt(0)===34&&(a=a.slice(1,-1));try{t[r]=s(a)}catch{t[r]=a}}i=n+1}return t}function M(c,e,t){const s=Object.assign({},t||{}),i=s.encode||Z;if(!A.test(c))throw new TypeError("argument name is invalid");const o=i(e);if(o&&!A.test(o))throw new TypeError("argument val is invalid");let n=c+"="+o;if(s.maxAge!=null){const r=s.maxAge-0;if(isNaN(r)||!isFinite(r))throw new TypeError("option maxAge is invalid");n+="; Max-Age="+Math.floor(r)}if(s.domain){if(!A.test(s.domain))throw new TypeError("option domain is invalid");n+="; Domain="+s.domain}if(s.path){if(!A.test(s.path))throw new TypeError("option path is invalid");n+="; Path="+s.path}if(s.expires){if(!function(a){return Object.prototype.toString.call(a)==="[object Date]"||a instanceof Date}(s.expires)||isNaN(s.expires.valueOf()))throw new TypeError("option expires is invalid");n+="; Expires="+s.expires.toUTCString()}if(s.httpOnly&&(n+="; HttpOnly"),s.secure&&(n+="; Secure"),s.priority)switch(typeof s.priority=="string"?s.priority.toLowerCase():s.priority){case"low":n+="; Priority=Low";break;case"medium":n+="; Priority=Medium";break;case"high":n+="; Priority=High";break;default:throw new TypeError("option priority is invalid")}if(s.sameSite)switch(typeof s.sameSite=="string"?s.sameSite.toLowerCase():s.sameSite){case!0:n+="; SameSite=Strict";break;case"lax":n+="; SameSite=Lax";break;case"strict":n+="; SameSite=Strict";break;case"none":n+="; SameSite=None";break;default:throw new TypeError("option sameSite is invalid")}return n}function J(c){return c.indexOf("%")!==-1?decodeURIComponent(c):c}function Z(c){return encodeURIComponent(c)}const Q=typeof navigator<"u"&&navigator.product==="ReactNative"||typeof global<"u"&&global.HermesInternal;let q;function P(c){if(c)try{const e=decodeURIComponent(q(c.split(".")[1]).split("").map(function(t){return"%"+("00"+t.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(e)||{}}catch{}return{}}function N(c,e=0){let t=P(c);return!(Object.keys(t).length>0&&(!t.exp||t.exp-e>Date.now()/1e3))}q=typeof atob!="function"||Q?c=>{let e=String(c).replace(/=+$/,"");if(e.length%4==1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(var t,s,i=0,o=0,n="";s=e.charAt(o++);~s&&(t=i%4?64*t+s:s,i++%4)?n+=String.fromCharCode(255&t>>(-2*i&6)):0)s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(s);return n}:atob;const B="pb_auth";class ee{constructor(){this.baseToken="",this.baseModel=null,this._onChangeCallbacks=[]}get token(){return this.baseToken}get model(){return this.baseModel}get isValid(){return!N(this.token)}get isAdmin(){return P(this.token).type==="admin"}get isAuthRecord(){return P(this.token).type==="authRecord"}save(e,t){this.baseToken=e||"",this.baseModel=t||null,this.triggerChange()}clear(){this.baseToken="",this.baseModel=null,this.triggerChange()}loadFromCookie(e,t=B){const s=V(e||"")[t]||"";let i={};try{i=JSON.parse(s),(typeof i===null||typeof i!="object"||Array.isArray(i))&&(i={})}catch{}this.save(i.token||"",i.model||null)}exportToCookie(e,t=B){var a,l;const s={secure:!0,sameSite:!0,httpOnly:!0,path:"/"},i=P(this.token);s.expires=i!=null&&i.exp?new Date(1e3*i.exp):new Date("1970-01-01"),e=Object.assign({},s,e);const o={token:this.token,model:this.model?JSON.parse(JSON.stringify(this.model)):null};let n=M(t,JSON.stringify(o),e);const r=typeof Blob<"u"?new Blob([n]).size:n.length;if(o.model&&r>4096){o.model={id:(a=o==null?void 0:o.model)==null?void 0:a.id,email:(l=o==null?void 0:o.model)==null?void 0:l.email};const h=["collectionId","username","verified"];for(const d in this.model)h.includes(d)&&(o.model[d]=this.model[d]);n=M(t,JSON.stringify(o),e)}return n}onChange(e,t=!1){return this._onChangeCallbacks.push(e),t&&e(this.token,this.model),()=>{for(let s=this._onChangeCallbacks.length-1;s>=0;s--)if(this._onChangeCallbacks[s]==e)return delete this._onChangeCallbacks[s],void this._onChangeCallbacks.splice(s,1)}}triggerChange(){for(const e of this._onChangeCallbacks)e&&e(this.token,this.model)}}class te extends ee{constructor(e="pocketbase_auth"){super(),this.storageFallback={},this.storageKey=e,this._bindStorageEvent()}get token(){return(this._storageGet(this.storageKey)||{}).token||""}get model(){return(this._storageGet(this.storageKey)||{}).model||null}save(e,t){this._storageSet(this.storageKey,{token:e,model:t}),super.save(e,t)}clear(){this._storageRemove(this.storageKey),super.clear()}_storageGet(e){if(typeof window<"u"&&(window!=null&&window.localStorage)){const t=window.localStorage.getItem(e)||"";try{return JSON.parse(t)}catch{return t}}return this.storageFallback[e]}_storageSet(e,t){if(typeof window<"u"&&(window!=null&&window.localStorage)){let s=t;typeof t!="string"&&(s=JSON.stringify(t)),window.localStorage.setItem(e,s)}else this.storageFallback[e]=t}_storageRemove(e){var t;typeof window<"u"&&(window!=null&&window.localStorage)&&((t=window.localStorage)==null||t.removeItem(e)),delete this.storageFallback[e]}_bindStorageEvent(){typeof window<"u"&&(window!=null&&window.localStorage)&&window.addEventListener&&window.addEventListener("storage",e=>{if(e.key!=this.storageKey)return;const t=this._storageGet(this.storageKey)||{};super.save(t.token||"",t.model||null)})}}class T{constructor(e){this.client=e}}class se extends T{async getAll(e){return e=Object.assign({method:"GET"},e),this.client.send("/api/settings",e)}async update(e,t){return t=Object.assign({method:"PATCH",body:e},t),this.client.send("/api/settings",t)}async testS3(e="storage",t){return t=Object.assign({method:"POST",body:{filesystem:e}},t),this.client.send("/api/settings/test/s3",t).then(()=>!0)}async testEmail(e,t,s){return s=Object.assign({method:"POST",body:{email:e,template:t}},s),this.client.send("/api/settings/test/email",s).then(()=>!0)}async generateAppleClientSecret(e,t,s,i,o,n){return n=Object.assign({method:"POST",body:{clientId:e,teamId:t,keyId:s,privateKey:i,duration:o}},n),this.client.send("/api/settings/apple/generate-client-secret",n)}}class z extends T{decode(e){return e}async getFullList(e,t){if(typeof e=="number")return this._getFullList(e,t);let s=500;return(t=Object.assign({},e,t)).batch&&(s=t.batch,delete t.batch),this._getFullList(s,t)}async getList(e=1,t=30,s){return(s=Object.assign({method:"GET"},s)).query=Object.assign({page:e,perPage:t},s.query),this.client.send(this.baseCrudPath,s).then(i=>{var o;return i.items=((o=i.items)==null?void 0:o.map(n=>this.decode(n)))||[],i})}async getFirstListItem(e,t){return(t=Object.assign({requestKey:"one_by_filter_"+this.baseCrudPath+"_"+e},t)).query=Object.assign({filter:e,skipTotal:1},t.query),this.getList(1,1,t).then(s=>{var i;if(!((i=s==null?void 0:s.items)!=null&&i.length))throw new b({status:404,response:{code:404,message:"The requested resource wasn't found.",data:{}}});return s.items[0]})}async getOne(e,t){if(!e)throw new b({url:this.client.buildUrl(this.baseCrudPath+"/"),status:404,response:{code:404,message:"Missing required record id.",data:{}}});return t=Object.assign({method:"GET"},t),this.client.send(this.baseCrudPath+"/"+encodeURIComponent(e),t).then(s=>this.decode(s))}async create(e,t){return t=Object.assign({method:"POST",body:e},t),this.client.send(this.baseCrudPath,t).then(s=>this.decode(s))}async update(e,t,s){return s=Object.assign({method:"PATCH",body:t},s),this.client.send(this.baseCrudPath+"/"+encodeURIComponent(e),s).then(i=>this.decode(i))}async delete(e,t){return t=Object.assign({method:"DELETE"},t),this.client.send(this.baseCrudPath+"/"+encodeURIComponent(e),t).then(()=>!0)}_getFullList(e=500,t){(t=t||{}).query=Object.assign({skipTotal:1},t.query);let s=[],i=async o=>this.getList(o,e||500,t).then(n=>{const r=n.items;return s=s.concat(r),r.length==n.perPage?i(o+1):s});return i(1)}}function g(c,e,t,s){const i=s!==void 0;return i||t!==void 0?i?(console.warn(c),e.body=Object.assign({},e.body,t),e.query=Object.assign({},e.query,s),e):Object.assign(e,t):e}function _(c){var e;(e=c._resetAutoRefresh)==null||e.call(c)}class ie extends z{get baseCrudPath(){return"/api/admins"}async update(e,t,s){return super.update(e,t,s).then(i=>{var o,n;return((o=this.client.authStore.model)==null?void 0:o.id)===i.id&&((n=this.client.authStore.model)==null?void 0:n.collectionId)===void 0&&this.client.authStore.save(this.client.authStore.token,i),i})}async delete(e,t){return super.delete(e,t).then(s=>{var i,o;return s&&((i=this.client.authStore.model)==null?void 0:i.id)===e&&((o=this.client.authStore.model)==null?void 0:o.collectionId)===void 0&&this.client.authStore.clear(),s})}authResponse(e){const t=this.decode((e==null?void 0:e.admin)||{});return e!=null&&e.token&&(e!=null&&e.admin)&&this.client.authStore.save(e.token,t),Object.assign({},e,{token:(e==null?void 0:e.token)||"",admin:t})}async authWithPassword(e,t,s,i){let o={method:"POST",body:{identity:e,password:t}};o=g("This form of authWithPassword(email, pass, body?, query?) is deprecated. Consider replacing it with authWithPassword(email, pass, options?).",o,s,i);const n=o.autoRefreshThreshold;delete o.autoRefreshThreshold,o.autoRefresh||_(this.client);let r=await this.client.send(this.baseCrudPath+"/auth-with-password",o);return r=this.authResponse(r),n&&function(l,h,d,S){_(l);const x=l.beforeSend,v=l.authStore.model,$=l.authStore.onChange((C,m)=>{(!C||(m==null?void 0:m.id)!=(v==null?void 0:v.id)||(m!=null&&m.collectionId||v!=null&&v.collectionId)&&(m==null?void 0:m.collectionId)!=(v==null?void 0:v.collectionId))&&_(l)});l._resetAutoRefresh=function(){$(),l.beforeSend=x,delete l._resetAutoRefresh},l.beforeSend=async(C,m)=>{var I;const F=l.authStore.token;if((I=m.query)!=null&&I.autoRefresh)return x?x(C,m):{url:C,sendOptions:m};let y=l.authStore.isValid;if(y&&N(l.authStore.token,h))try{await d()}catch{y=!1}y||await S();const E=m.headers||{};for(let w in E)if(w.toLowerCase()=="authorization"&&F==E[w]&&l.authStore.token){E[w]=l.authStore.token;break}return m.headers=E,x?x(C,m):{url:C,sendOptions:m}}}(this.client,n,()=>this.authRefresh({autoRefresh:!0}),()=>this.authWithPassword(e,t,Object.assign({autoRefresh:!0},o))),r}async authRefresh(e,t){let s={method:"POST"};return s=g("This form of authRefresh(body?, query?) is deprecated. Consider replacing it with authRefresh(options?).",s,e,t),this.client.send(this.baseCrudPath+"/auth-refresh",s).then(this.authResponse.bind(this))}async requestPasswordReset(e,t,s){let i={method:"POST",body:{email:e}};return i=g("This form of requestPasswordReset(email, body?, query?) is deprecated. Consider replacing it with requestPasswordReset(email, options?).",i,t,s),this.client.send(this.baseCrudPath+"/request-password-reset",i).then(()=>!0)}async confirmPasswordReset(e,t,s,i,o){let n={method:"POST",body:{token:e,password:t,passwordConfirm:s}};return n=g("This form of confirmPasswordReset(resetToken, password, passwordConfirm, body?, query?) is deprecated. Consider replacing it with confirmPasswordReset(resetToken, password, passwordConfirm, options?).",n,i,o),this.client.send(this.baseCrudPath+"/confirm-password-reset",n).then(()=>!0)}}const oe=["requestKey","$cancelKey","$autoCancel","fetch","headers","body","query","params","cache","credentials","headers","integrity","keepalive","method","mode","redirect","referrer","referrerPolicy","signal","window"];function D(c){if(c){c.query=c.query||{};for(let e in c)oe.includes(e)||(c.query[e]=c[e],delete c[e])}}class W extends T{constructor(){super(...arguments),this.clientId="",this.eventSource=null,this.subscriptions={},this.lastSentSubscriptions=[],this.maxConnectTimeout=15e3,this.reconnectAttempts=0,this.maxReconnectAttempts=1/0,this.predefinedReconnectIntervals=[200,300,500,1e3,1200,1500,2e3],this.pendingConnects=[]}get isConnected(){return!!this.eventSource&&!!this.clientId&&!this.pendingConnects.length}async subscribe(e,t,s){var n;if(!e)throw new Error("topic must be set.");let i=e;if(s){D(s=Object.assign({},s));const r="options="+encodeURIComponent(JSON.stringify({query:s.query,headers:s.headers}));i+=(i.includes("?")?"&":"?")+r}const o=function(r){const a=r;let l;try{l=JSON.parse(a==null?void 0:a.data)}catch{}t(l||{})};return this.subscriptions[i]||(this.subscriptions[i]=[]),this.subscriptions[i].push(o),this.isConnected?this.subscriptions[i].length===1?await this.submitSubscriptions():(n=this.eventSource)==null||n.addEventListener(i,o):await this.connect(),async()=>this.unsubscribeByTopicAndListener(e,o)}async unsubscribe(e){var s;let t=!1;if(e){const i=this.getSubscriptionsByTopic(e);for(let o in i)if(this.hasSubscriptionListeners(o)){for(let n of this.subscriptions[o])(s=this.eventSource)==null||s.removeEventListener(o,n);delete this.subscriptions[o],t||(t=!0)}}else this.subscriptions={};this.hasSubscriptionListeners()?t&&await this.submitSubscriptions():this.disconnect()}async unsubscribeByPrefix(e){var s;let t=!1;for(let i in this.subscriptions)if((i+"?").startsWith(e)){t=!0;for(let o of this.subscriptions[i])(s=this.eventSource)==null||s.removeEventListener(i,o);delete this.subscriptions[i]}t&&(this.hasSubscriptionListeners()?await this.submitSubscriptions():this.disconnect())}async unsubscribeByTopicAndListener(e,t){var o;let s=!1;const i=this.getSubscriptionsByTopic(e);for(let n in i){if(!Array.isArray(this.subscriptions[n])||!this.subscriptions[n].length)continue;let r=!1;for(let a=this.subscriptions[n].length-1;a>=0;a--)this.subscriptions[n][a]===t&&(r=!0,delete this.subscriptions[n][a],this.subscriptions[n].splice(a,1),(o=this.eventSource)==null||o.removeEventListener(n,t));r&&(this.subscriptions[n].length||delete this.subscriptions[n],s||this.hasSubscriptionListeners(n)||(s=!0))}this.hasSubscriptionListeners()?s&&await this.submitSubscriptions():this.disconnect()}hasSubscriptionListeners(e){var t,s;if(this.subscriptions=this.subscriptions||{},e)return!!((t=this.subscriptions[e])!=null&&t.length);for(let i in this.subscriptions)if((s=this.subscriptions[i])!=null&&s.length)return!0;return!1}async submitSubscriptions(){if(this.clientId)return this.addAllSubscriptionListeners(),this.lastSentSubscriptions=this.getNonEmptySubscriptionKeys(),this.client.send("/api/realtime",{method:"POST",body:{clientId:this.clientId,subscriptions:this.lastSentSubscriptions},requestKey:this.getSubscriptionsCancelKey()}).catch(e=>{if(!(e!=null&&e.isAbort))throw e})}getSubscriptionsCancelKey(){return"realtime_"+this.clientId}getSubscriptionsByTopic(e){const t={};e=e.includes("?")?e:e+"?";for(let s in this.subscriptions)(s+"?").startsWith(e)&&(t[s]=this.subscriptions[s]);return t}getNonEmptySubscriptionKeys(){const e=[];for(let t in this.subscriptions)this.subscriptions[t].length&&e.push(t);return e}addAllSubscriptionListeners(){if(this.eventSource){this.removeAllSubscriptionListeners();for(let e in this.subscriptions)for(let t of this.subscriptions[e])this.eventSource.addEventListener(e,t)}}removeAllSubscriptionListeners(){if(this.eventSource)for(let e in this.subscriptions)for(let t of this.subscriptions[e])this.eventSource.removeEventListener(e,t)}async connect(){if(!(this.reconnectAttempts>0))return new Promise((e,t)=>{this.pendingConnects.push({resolve:e,reject:t}),this.pendingConnects.length>1||this.initConnect()})}initConnect(){this.disconnect(!0),clearTimeout(this.connectTimeoutId),this.connectTimeoutId=setTimeout(()=>{this.connectErrorHandler(new Error("EventSource connect took too long."))},this.maxConnectTimeout),this.eventSource=new EventSource(this.client.buildUrl("/api/realtime")),this.eventSource.onerror=e=>{this.connectErrorHandler(new Error("Failed to establish realtime connection."))},this.eventSource.addEventListener("PB_CONNECT",e=>{const t=e;this.clientId=t==null?void 0:t.lastEventId,this.submitSubscriptions().then(async()=>{let s=3;for(;this.hasUnsentSubscriptions()&&s>0;)s--,await this.submitSubscriptions()}).then(()=>{for(let i of this.pendingConnects)i.resolve();this.pendingConnects=[],this.reconnectAttempts=0,clearTimeout(this.reconnectTimeoutId),clearTimeout(this.connectTimeoutId);const s=this.getSubscriptionsByTopic("PB_CONNECT");for(let i in s)for(let o of s[i])o(e)}).catch(s=>{this.clientId="",this.connectErrorHandler(s)})})}hasUnsentSubscriptions(){const e=this.getNonEmptySubscriptionKeys();if(e.length!=this.lastSentSubscriptions.length)return!0;for(const t of e)if(!this.lastSentSubscriptions.includes(t))return!0;return!1}connectErrorHandler(e){if(clearTimeout(this.connectTimeoutId),clearTimeout(this.reconnectTimeoutId),!this.clientId&&!this.reconnectAttempts||this.reconnectAttempts>this.maxReconnectAttempts){for(let s of this.pendingConnects)s.reject(new b(e));return this.pendingConnects=[],void this.disconnect()}this.disconnect(!0);const t=this.predefinedReconnectIntervals[this.reconnectAttempts]||this.predefinedReconnectIntervals[this.predefinedReconnectIntervals.length-1];this.reconnectAttempts++,this.reconnectTimeoutId=setTimeout(()=>{this.initConnect()},t)}disconnect(e=!1){var t;if(clearTimeout(this.connectTimeoutId),clearTimeout(this.reconnectTimeoutId),this.removeAllSubscriptionListeners(),this.client.cancelRequest(this.getSubscriptionsCancelKey()),(t=this.eventSource)==null||t.close(),this.eventSource=null,this.clientId="",!e){this.reconnectAttempts=0;for(let s of this.pendingConnects)s.resolve();this.pendingConnects=[]}}}class ne extends z{constructor(e,t){super(e),this.collectionIdOrName=t}get baseCrudPath(){return this.baseCollectionPath+"/records"}get baseCollectionPath(){return"/api/collections/"+encodeURIComponent(this.collectionIdOrName)}async subscribe(e,t,s){if(!e)throw new Error("Missing topic.");if(!t)throw new Error("Missing subscription callback.");return this.client.realtime.subscribe(this.collectionIdOrName+"/"+e,t,s)}async unsubscribe(e){return e?this.client.realtime.unsubscribe(this.collectionIdOrName+"/"+e):this.client.realtime.unsubscribeByPrefix(this.collectionIdOrName)}async getFullList(e,t){if(typeof e=="number")return super.getFullList(e,t);const s=Object.assign({},e,t);return super.getFullList(s)}async getList(e=1,t=30,s){return super.getList(e,t,s)}async getFirstListItem(e,t){return super.getFirstListItem(e,t)}async getOne(e,t){return super.getOne(e,t)}async create(e,t){return super.create(e,t)}async update(e,t,s){return super.update(e,t,s).then(i=>{var o,n,r;return((o=this.client.authStore.model)==null?void 0:o.id)!==(i==null?void 0:i.id)||((n=this.client.authStore.model)==null?void 0:n.collectionId)!==this.collectionIdOrName&&((r=this.client.authStore.model)==null?void 0:r.collectionName)!==this.collectionIdOrName||this.client.authStore.save(this.client.authStore.token,i),i})}async delete(e,t){return super.delete(e,t).then(s=>{var i,o,n;return!s||((i=this.client.authStore.model)==null?void 0:i.id)!==e||((o=this.client.authStore.model)==null?void 0:o.collectionId)!==this.collectionIdOrName&&((n=this.client.authStore.model)==null?void 0:n.collectionName)!==this.collectionIdOrName||this.client.authStore.clear(),s})}authResponse(e){const t=this.decode((e==null?void 0:e.record)||{});return this.client.authStore.save(e==null?void 0:e.token,t),Object.assign({},e,{token:(e==null?void 0:e.token)||"",record:t})}async listAuthMethods(e){return e=Object.assign({method:"GET"},e),this.client.send(this.baseCollectionPath+"/auth-methods",e).then(t=>Object.assign({},t,{usernamePassword:!!(t!=null&&t.usernamePassword),emailPassword:!!(t!=null&&t.emailPassword),authProviders:Array.isArray(t==null?void 0:t.authProviders)?t==null?void 0:t.authProviders:[]}))}async authWithPassword(e,t,s,i){let o={method:"POST",body:{identity:e,password:t}};return o=g("This form of authWithPassword(usernameOrEmail, pass, body?, query?) is deprecated. Consider replacing it with authWithPassword(usernameOrEmail, pass, options?).",o,s,i),this.client.send(this.baseCollectionPath+"/auth-with-password",o).then(n=>this.authResponse(n))}async authWithOAuth2Code(e,t,s,i,o,n,r){let a={method:"POST",body:{provider:e,code:t,codeVerifier:s,redirectUrl:i,createData:o}};return a=g("This form of authWithOAuth2Code(provider, code, codeVerifier, redirectUrl, createData?, body?, query?) is deprecated. Consider replacing it with authWithOAuth2Code(provider, code, codeVerifier, redirectUrl, createData?, options?).",a,n,r),this.client.send(this.baseCollectionPath+"/auth-with-oauth2",a).then(l=>this.authResponse(l))}authWithOAuth2(...e){if(e.length>1||typeof(e==null?void 0:e[0])=="string")return console.warn("PocketBase: This form of authWithOAuth2() is deprecated and may get removed in the future. Please replace with authWithOAuth2Code() OR use the authWithOAuth2() realtime form as shown in https://pocketbase.io/docs/authentication/#oauth2-integration."),this.authWithOAuth2Code((e==null?void 0:e[0])||"",(e==null?void 0:e[1])||"",(e==null?void 0:e[2])||"",(e==null?void 0:e[3])||"",(e==null?void 0:e[4])||{},(e==null?void 0:e[5])||{},(e==null?void 0:e[6])||{});const t=(e==null?void 0:e[0])||{};let s=null;t.urlCallback||(s=U(void 0));const i=new W(this.client);function o(){s==null||s.close(),i.unsubscribe()}const n={},r=t.requestKey;return r&&(n.requestKey=r),this.listAuthMethods(n).then(a=>{var S;const l=a.authProviders.find(x=>x.name===t.provider);if(!l)throw new b(new Error(`Missing or invalid provider "${t.provider}".`));const h=this.client.buildUrl("/api/oauth2-redirect"),d=r?(S=this.client.cancelControllers)==null?void 0:S[r]:void 0;return d&&(d.signal.onabort=()=>{o()}),new Promise(async(x,v)=>{var $;try{await i.subscribe("@oauth2",async y=>{var I;const E=i.clientId;try{if(!y.state||E!==y.state)throw new Error("State parameters don't match.");if(y.error||!y.code)throw new Error("OAuth2 redirect error or missing code: "+y.error);const w=Object.assign({},t);delete w.provider,delete w.scopes,delete w.createData,delete w.urlCallback,(I=d==null?void 0:d.signal)!=null&&I.onabort&&(d.signal.onabort=null);const H=await this.authWithOAuth2Code(l.name,y.code,l.codeVerifier,h,t.createData,w);x(H)}catch(w){v(new b(w))}o()});const C={state:i.clientId};($=t.scopes)!=null&&$.length&&(C.scope=t.scopes.join(" "));const m=this._replaceQueryParams(l.authUrl+h,C);await(t.urlCallback||function(y){s?s.location.href=y:s=U(y)})(m)}catch(C){o(),v(new b(C))}})}).catch(a=>{throw o(),a})}async authRefresh(e,t){let s={method:"POST"};return s=g("This form of authRefresh(body?, query?) is deprecated. Consider replacing it with authRefresh(options?).",s,e,t),this.client.send(this.baseCollectionPath+"/auth-refresh",s).then(i=>this.authResponse(i))}async requestPasswordReset(e,t,s){let i={method:"POST",body:{email:e}};return i=g("This form of requestPasswordReset(email, body?, query?) is deprecated. Consider replacing it with requestPasswordReset(email, options?).",i,t,s),this.client.send(this.baseCollectionPath+"/request-password-reset",i).then(()=>!0)}async confirmPasswordReset(e,t,s,i,o){let n={method:"POST",body:{token:e,password:t,passwordConfirm:s}};return n=g("This form of confirmPasswordReset(token, password, passwordConfirm, body?, query?) is deprecated. Consider replacing it with confirmPasswordReset(token, password, passwordConfirm, options?).",n,i,o),this.client.send(this.baseCollectionPath+"/confirm-password-reset",n).then(()=>!0)}async requestVerification(e,t,s){let i={method:"POST",body:{email:e}};return i=g("This form of requestVerification(email, body?, query?) is deprecated. Consider replacing it with requestVerification(email, options?).",i,t,s),this.client.send(this.baseCollectionPath+"/request-verification",i).then(()=>!0)}async confirmVerification(e,t,s){let i={method:"POST",body:{token:e}};return i=g("This form of confirmVerification(token, body?, query?) is deprecated. Consider replacing it with confirmVerification(token, options?).",i,t,s),this.client.send(this.baseCollectionPath+"/confirm-verification",i).then(()=>{const o=P(e),n=this.client.authStore.model;return n&&!n.verified&&n.id===o.id&&n.collectionId===o.collectionId&&(n.verified=!0,this.client.authStore.save(this.client.authStore.token,n)),!0})}async requestEmailChange(e,t,s){let i={method:"POST",body:{newEmail:e}};return i=g("This form of requestEmailChange(newEmail, body?, query?) is deprecated. Consider replacing it with requestEmailChange(newEmail, options?).",i,t,s),this.client.send(this.baseCollectionPath+"/request-email-change",i).then(()=>!0)}async confirmEmailChange(e,t,s,i){let o={method:"POST",body:{token:e,password:t}};return o=g("This form of confirmEmailChange(token, password, body?, query?) is deprecated. Consider replacing it with confirmEmailChange(token, password, options?).",o,s,i),this.client.send(this.baseCollectionPath+"/confirm-email-change",o).then(()=>{const n=P(e),r=this.client.authStore.model;return r&&r.id===n.id&&r.collectionId===n.collectionId&&this.client.authStore.clear(),!0})}async listExternalAuths(e,t){return t=Object.assign({method:"GET"},t),this.client.send(this.baseCrudPath+"/"+encodeURIComponent(e)+"/external-auths",t)}async unlinkExternalAuth(e,t,s){return s=Object.assign({method:"DELETE"},s),this.client.send(this.baseCrudPath+"/"+encodeURIComponent(e)+"/external-auths/"+encodeURIComponent(t),s).then(()=>!0)}_replaceQueryParams(e,t={}){let s=e,i="";e.indexOf("?")>=0&&(s=e.substring(0,e.indexOf("?")),i=e.substring(e.indexOf("?")+1));const o={},n=i.split("&");for(const r of n){if(r=="")continue;const a=r.split("=");o[decodeURIComponent(a[0].replace(/\+/g," "))]=decodeURIComponent((a[1]||"").replace(/\+/g," "))}for(let r in t)t.hasOwnProperty(r)&&(t[r]==null?delete o[r]:o[r]=t[r]);i="";for(let r in o)o.hasOwnProperty(r)&&(i!=""&&(i+="&"),i+=encodeURIComponent(r.replace(/%20/g,"+"))+"="+encodeURIComponent(o[r].replace(/%20/g,"+")));return i!=""?s+"?"+i:s}}function U(c){if(typeof window>"u"||!(window!=null&&window.open))throw new b(new Error("Not in a browser context - please pass a custom urlCallback function."));let e=1024,t=768,s=window.innerWidth,i=window.innerHeight;e=e>s?s:e,t=t>i?i:t;let o=s/2-e/2,n=i/2-t/2;return window.open(c,"popup_window","width="+e+",height="+t+",top="+n+",left="+o+",resizable,menubar=no")}class re extends z{get baseCrudPath(){return"/api/collections"}async import(e,t=!1,s){return s=Object.assign({method:"PUT",body:{collections:e,deleteMissing:t}},s),this.client.send(this.baseCrudPath+"/import",s).then(()=>!0)}}class ae extends T{async getList(e=1,t=30,s){return(s=Object.assign({method:"GET"},s)).query=Object.assign({page:e,perPage:t},s.query),this.client.send("/api/logs",s)}async getOne(e,t){if(!e)throw new b({url:this.client.buildUrl("/api/logs/"),status:404,response:{code:404,message:"Missing required log id.",data:{}}});return t=Object.assign({method:"GET"},t),this.client.send("/api/logs/"+encodeURIComponent(e),t)}async getStats(e){return e=Object.assign({method:"GET"},e),this.client.send("/api/logs/stats",e)}}class ce extends T{async check(e){return e=Object.assign({method:"GET"},e),this.client.send("/api/health",e)}}class le extends T{getUrl(e,t,s={}){if(!t||!(e!=null&&e.id)||!(e!=null&&e.collectionId)&&!(e!=null&&e.collectionName))return"";const i=[];i.push("api"),i.push("files"),i.push(encodeURIComponent(e.collectionId||e.collectionName)),i.push(encodeURIComponent(e.id)),i.push(encodeURIComponent(t));let o=this.client.buildUrl(i.join("/"));if(Object.keys(s).length){s.download===!1&&delete s.download;const n=new URLSearchParams(s);o+=(o.includes("?")?"&":"?")+n}return o}async getToken(e){return e=Object.assign({method:"POST"},e),this.client.send("/api/files/token",e).then(t=>(t==null?void 0:t.token)||"")}}class de extends T{async getFullList(e){return e=Object.assign({method:"GET"},e),this.client.send("/api/backups",e)}async create(e,t){return t=Object.assign({method:"POST",body:{name:e}},t),this.client.send("/api/backups",t).then(()=>!0)}async upload(e,t){return t=Object.assign({method:"POST",body:e},t),this.client.send("/api/backups/upload",t).then(()=>!0)}async delete(e,t){return t=Object.assign({method:"DELETE"},t),this.client.send(`/api/backups/${encodeURIComponent(e)}`,t).then(()=>!0)}async restore(e,t){return t=Object.assign({method:"POST"},t),this.client.send(`/api/backups/${encodeURIComponent(e)}/restore`,t).then(()=>!0)}getDownloadUrl(e,t){return this.client.buildUrl(`/api/backups/${encodeURIComponent(t)}?token=${encodeURIComponent(e)}`)}}class he{constructor(e="/",t,s="en-US"){this.cancelControllers={},this.recordServices={},this.enableAutoCancellation=!0,this.baseUrl=e,this.lang=s,this.authStore=t||new te,this.admins=new ie(this),this.collections=new re(this),this.files=new le(this),this.logs=new ae(this),this.settings=new se(this),this.realtime=new W(this),this.health=new ce(this),this.backups=new de(this)}collection(e){return this.recordServices[e]||(this.recordServices[e]=new ne(this,e)),this.recordServices[e]}autoCancellation(e){return this.enableAutoCancellation=!!e,this}cancelRequest(e){return this.cancelControllers[e]&&(this.cancelControllers[e].abort(),delete this.cancelControllers[e]),this}cancelAllRequests(){for(let e in this.cancelControllers)this.cancelControllers[e].abort();return this.cancelControllers={},this}filter(e,t){if(!t)return e;for(let s in t){let i=t[s];switch(typeof i){case"boolean":case"number":i=""+i;break;case"string":i="'"+i.replace(/'/g,"\\'")+"'";break;default:i=i===null?"null":i instanceof Date?"'"+i.toISOString().replace("T"," ")+"'":"'"+JSON.stringify(i).replace(/'/g,"\\'")+"'"}e=e.replaceAll("{:"+s+"}",i)}return e}getFileUrl(e,t,s={}){return this.files.getUrl(e,t,s)}buildUrl(e){var s;let t=this.baseUrl;return typeof window>"u"||!window.location||t.startsWith("https://")||t.startsWith("http://")||(t=(s=window.location.origin)!=null&&s.endsWith("/")?window.location.origin.substring(0,window.location.origin.length-1):window.location.origin||"",this.baseUrl.startsWith("/")||(t+=window.location.pathname||"/",t+=t.endsWith("/")?"":"/"),t+=this.baseUrl),e&&(t+=t.endsWith("/")?"":"/",t+=e.startsWith("/")?e.substring(1):e),t}async send(e,t){t=this.initSendOptions(e,t);let s=this.buildUrl(e);if(this.beforeSend){const i=Object.assign({},await this.beforeSend(s,t));i.url!==void 0||i.options!==void 0?(s=i.url||s,t=i.options||t):Object.keys(i).length&&(t=i,console!=null&&console.warn&&console.warn("Deprecated format of beforeSend return: please use `return { url, options }`, instead of `return options`."))}if(t.query!==void 0){const i=this.serializeQueryParams(t.query);i&&(s+=(s.includes("?")?"&":"?")+i),delete t.query}return this.getHeader(t.headers,"Content-Type")=="application/json"&&t.body&&typeof t.body!="string"&&(t.body=JSON.stringify(t.body)),(t.fetch||fetch)(s,t).then(async i=>{let o={};try{o=await i.json()}catch{}if(this.afterSend&&(o=await this.afterSend(i,o)),i.status>=400)throw new b({url:i.url,status:i.status,data:o});return o}).catch(i=>{throw new b(i)})}initSendOptions(e,t){if((t=Object.assign({method:"GET"},t)).body=this.convertToFormDataIfNeeded(t.body),D(t),t.query=Object.assign({},t.params,t.query),t.requestKey===void 0&&(t.$autoCancel===!1||t.query.$autoCancel===!1?t.requestKey=null:(t.$cancelKey||t.query.$cancelKey)&&(t.requestKey=t.$cancelKey||t.query.$cancelKey)),delete t.$autoCancel,delete t.query.$autoCancel,delete t.$cancelKey,delete t.query.$cancelKey,this.getHeader(t.headers,"Content-Type")!==null||this.isFormData(t.body)||(t.headers=Object.assign({},t.headers,{"Content-Type":"application/json"})),this.getHeader(t.headers,"Accept-Language")===null&&(t.headers=Object.assign({},t.headers,{"Accept-Language":this.lang})),this.authStore.token&&this.getHeader(t.headers,"Authorization")===null&&(t.headers=Object.assign({},t.headers,{Authorization:this.authStore.token})),this.enableAutoCancellation&&t.requestKey!==null){const s=t.requestKey||(t.method||"GET")+e;delete t.requestKey,this.cancelRequest(s);const i=new AbortController;this.cancelControllers[s]=i,t.signal=i.signal}return t}convertToFormDataIfNeeded(e){if(typeof FormData>"u"||e===void 0||typeof e!="object"||e===null||this.isFormData(e)||!this.hasBlobField(e))return e;const t=new FormData;for(const s in e){const i=e[s];if(typeof i!="object"||this.hasBlobField({data:i})){const o=Array.isArray(i)?i:[i];for(let n of o)t.append(s,n)}else{let o={};o[s]=i,t.append("@jsonPayload",JSON.stringify(o))}}return t}hasBlobField(e){for(const t in e){const s=Array.isArray(e[t])?e[t]:[e[t]];for(const i of s)if(typeof Blob<"u"&&i instanceof Blob||typeof File<"u"&&i instanceof File)return!0}return!1}getHeader(e,t){e=e||{},t=t.toLowerCase();for(let s in e)if(s.toLowerCase()==t)return e[s];return null}isFormData(e){return e&&(e.constructor.name==="FormData"||typeof FormData<"u"&&e instanceof FormData)}serializeQueryParams(e){const t=[];for(const s in e){if(e[s]===null)continue;const i=e[s],o=encodeURIComponent(s);if(Array.isArray(i))for(const n of i)t.push(o+"="+encodeURIComponent(n));else i instanceof Date?t.push(o+"="+encodeURIComponent(i.toISOString())):typeof i!==null&&typeof i=="object"?t.push(o+"="+encodeURIComponent(JSON.stringify(i))):t.push(o+"="+encodeURIComponent(i))}return t.join("&")}}const G="http://localhost:8090",u=new he(G);function O(c){var e;if(!((e=c.message)!=null&&e.includes("autocancelled")||c.status===0))throw c}class Y{constructor(){this.callbacks=[],this.user=null,this.checkAuthStatus(),u.authStore.onChange(()=>{this.checkAuthStatus(),this.notifyCallbacks()})}checkAuthStatus(){this.user=u.authStore.isValid?u.authStore.model:null}subscribe(e){this.callbacks.push(e),e(this.user)}unsubscribe(e){this.callbacks=this.callbacks.filter(t=>t!==e)}notifyCallbacks(){this.callbacks.forEach(e=>e(this.user))}async loginWithDiscord(){try{return await u.collection("users").authWithOAuth2({provider:"discord"})}catch(e){throw console.error("Discord login failed:",e),e}}logout(){u.authStore.clear()}isLoggedIn(){return u.authStore.isValid}getUser(){return this.user}}const f=new Y;class K{constructor(){this.ws=null,this.callbacks={systems:[],fleets:[],trades:[],tick:[]}}subscribe(e,t){this.callbacks[e]&&this.callbacks[e].push(t)}unsubscribe(e,t){this.callbacks[e]&&(this.callbacks[e]=this.callbacks[e].filter(s=>s!==t))}notifyCallbacks(e,t){this.callbacks[e]&&this.callbacks[e].forEach(s=>s(t))}connectWebSocket(){try{this.ws=new WebSocket(`${G.replace("http","ws")}/api/stream`),this.ws.onopen=()=>{console.log("WebSocket connected"),this.updateConnectionStatus("connected"),u.authStore.isValid&&setTimeout(()=>{this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({type:"auth",token:u.authStore.token}))},100)},this.ws.onmessage=e=>{try{const t=JSON.parse(e.data);this.handleWebSocketMessage(t)}catch(t){console.error("Failed to parse WebSocket message:",t)}},this.ws.onclose=()=>{console.log("WebSocket disconnected"),this.updateConnectionStatus("disconnected"),setTimeout(()=>this.connectWebSocket(),5e3)},this.ws.onerror=e=>{console.error("WebSocket error:",e),this.updateConnectionStatus("error")}}catch(e){console.error("Failed to connect WebSocket:",e),this.updateConnectionStatus("error")}}updateConnectionStatus(e){const t=document.getElementById("ws-status");t&&(t.textContent=e==="connected"?"🟢":e==="error"?"🔴":"🟡",t.title=`WebSocket: ${e}`)}handleWebSocketMessage(e){switch(e.type){case"tick":this.notifyCallbacks("tick",e.payload);break;case"system_update":this.notifyCallbacks("systems",e.payload);break;case"fleet_update":this.notifyCallbacks("fleets",e.payload);break;case"trade_update":this.notifyCallbacks("trades",e.payload);break;default:console.log("Unknown WebSocket message type:",e.type)}}async getSystems(){try{return await u.collection("systems").getFullList({sort:"x,y"})}catch(e){return console.error("Failed to fetch systems:",e),[]}}async getSystem(e){try{return await u.collection("systems").getOne(e)}catch(t){return console.error("Failed to fetch system:",t),null}}async getFleets(e=null){try{const t=e?`owner_id = "${e}"`:"";return await u.collection("fleets").getFullList({filter:t,sort:"eta"})}catch(t){try{O(t)}catch(s){console.error("Failed to fetch fleets:",s)}return[]}}async getTrades(e=null){try{const t=e?`owner_id = "${e}"`:"";return await u.collection("trade_routes").getFullList({filter:t,sort:"created"})}catch(t){try{O(t)}catch(s){console.error("Failed to fetch trades:",s)}return[]}}async getBuildings(e=null){try{return await u.collection("buildings").getFullList({sort:"created"})}catch(t){try{O(t)}catch(s){console.error("Failed to fetch buildings:",s)}return[]}}async getTreaties(e=null){try{return[]}catch(t){try{O(t)}catch(s){console.error("Failed to fetch treaties:",s)}return[]}}async sendFleet(e,t,s){if(!u.authStore.isValid)throw new Error("Not authenticated");try{return await u.send("/api/orders/fleet",{method:"POST",body:JSON.stringify({from_id:e,to_id:t,strength:s}),headers:{"Content-Type":"application/json"}})}catch(i){throw console.error("Failed to send fleet:",i),i}}async queueBuilding(e,t){if(!u.authStore.isValid)throw new Error("Not authenticated");try{return await u.send("/api/orders/build",{method:"POST",body:JSON.stringify({system_id:e,building_type:t}),headers:{"Content-Type":"application/json"}})}catch(s){throw console.error("Failed to queue building:",s),s}}async createTradeRoute(e,t,s,i){if(!u.authStore.isValid)throw new Error("Not authenticated");try{return await u.send("/api/orders/trade",{method:"POST",body:JSON.stringify({from_id:e,to_id:t,cargo:s,capacity:i}),headers:{"Content-Type":"application/json"}})}catch(o){throw console.error("Failed to create trade route:",o),o}}async proposeTreaty(e,t,s){if(!u.authStore.isValid)throw new Error("Not authenticated");try{return await u.send("/diplomacy",{method:"POST",body:JSON.stringify({player_id:e,type:t,terms:s}),headers:{"Content-Type":"application/json"}})}catch(i){throw console.error("Failed to propose treaty:",i),i}}async getMap(){var e;try{return await u.send("/api/map",{method:"GET"})}catch(t){return(e=t.message)!=null&&e.includes("autocancelled")||console.error("Failed to fetch map:",t),null}}async getStatus(){try{return await u.send("/api/status",{method:"GET"})}catch(e){try{O(e)}catch(t){console.error("Failed to fetch status:",t)}return null}}}const p=new K;f.subscribe(c=>{p.ws||p.connectWebSocket()});p.connectWebSocket();const R=Object.freeze(Object.defineProperty({__proto__:null,AuthManager:Y,GameDataManager:K,authManager:f,gameData:p,pb:u},Symbol.toStringTag,{value:"Module"}));class X{constructor(){this.systems=[],this.fleets=[],this.trades=[],this.treaties=[],this.buildings=[],this.mapData=null,this.selectedSystem=null,this.currentTick=1,this.ticksPerMinute=6,this.playerResources={credits:0,food:0,ore:0,goods:0,fuel:0},this.callbacks=[],this.initialized=!1,f.subscribe(e=>{e&&!this.initialized?this.initialize():e||this.reset()}),this.loadMapData(),p.subscribe("systems",e=>this.updateSystems(e)),p.subscribe("fleets",e=>this.updateFleets(e)),p.subscribe("trades",e=>this.updateTrades(e)),p.subscribe("tick",e=>this.handleTick(e))}async initialize(){if(!this.initialized)try{await this.loadGameData(),this.initialized=!0}catch(e){console.error("Failed to initialize game state:",e)}}async loadGameData(){var e;try{const t=(e=f.getUser())==null?void 0:e.id,s=await p.getMap();s&&s.systems&&(this.systems=s.systems,this.mapData=s),t&&(this.fleets=await p.getFleets(t),await new Promise(o=>setTimeout(o,50)),this.trades=await p.getTrades(t),await new Promise(o=>setTimeout(o,50)),this.treaties=await p.getTreaties(t),await new Promise(o=>setTimeout(o,50)),this.buildings=await p.getBuildings(t),await new Promise(o=>setTimeout(o,50)));const i=await p.getStatus();i&&(this.currentTick=i.current_tick||1,this.ticksPerMinute=i.ticks_per_minute||6),this.updatePlayerResources(),this.notifyCallbacks()}catch(t){console.error("Failed to load game data:",t)}}async refreshGameData(){if(!this.initialized){await this.initialize();return}await this.loadGameData()}reset(){this.systems=[],this.fleets=[],this.trades=[],this.treaties=[],this.buildings=[],this.mapData=null,this.selectedSystem=null,this.currentTick=1,this.ticksPerMinute=6,this.playerResources={credits:0,food:0,ore:0,goods:0,fuel:0},this.initialized=!1,this.notifyCallbacks()}async loadMapData(){try{console.log("GameState: Loading map data...");const e=await p.getMap();console.log("GameState: Received map data",e),e&&e.systems&&(console.log("GameState: Setting systems",e.systems.length,"systems"),this.systems=e.systems,this.mapData=e,this.notifyCallbacks())}catch(e){console.error("Failed to load map data:",e)}}subscribe(e){this.callbacks.push(e),e(this)}unsubscribe(e){this.callbacks=this.callbacks.filter(t=>t!==e)}notifyCallbacks(){this.callbacks.forEach(e=>e(this))}updateSystems(e){if(Array.isArray(e))this.systems=e;else{const t=this.systems.findIndex(s=>s.id===e.id);t>=0?this.systems[t]=e:this.systems.push(e)}this.updatePlayerResources(),this.notifyCallbacks()}updateFleets(e){if(Array.isArray(e))this.fleets=e;else{const t=this.fleets.findIndex(s=>s.id===e.id);t>=0?this.fleets[t]=e:this.fleets.push(e)}this.notifyCallbacks()}updateTrades(e){if(Array.isArray(e))this.trades=e;else{const t=this.trades.findIndex(s=>s.id===e.id);t>=0?this.trades[t]=e:this.trades.push(e)}this.notifyCallbacks()}handleTick(e){this.currentTick=e.tick||this.currentTick+1,console.log("Tick update received:",e,"Current tick:",this.currentTick),this.notifyCallbacks(),this.currentTick%6===0&&this.refreshGameData()}updatePlayerResources(){const e=f.getUser();if(!e)return;const t=e.credits||0,i=this.getPlayerBuildings().filter(n=>n.type==="bank"&&n.active!==!1).reduce((n,r)=>n+(r.credits_per_tick||1),0),o=this.systems.filter(n=>n.owner_id===e.id);this.playerResources=o.reduce((n,r)=>({credits:n.credits+(r.credits||0),food:n.food+(r.food||0),ore:n.ore+(r.ore||0),goods:n.goods+(r.goods||0),fuel:n.fuel+(r.fuel||0)}),{credits:t,food:0,ore:0,goods:0,fuel:0}),this.creditIncome=i}selectSystem(e){this.selectedSystem=this.systems.find(t=>t.id===e)||null,this.notifyCallbacks()}getSelectedSystem(){return this.selectedSystem}getOwnedSystems(){const e=f.getUser();return e?this.systems.filter(t=>t.owner_id===e.id):[]}getPlayerFleets(){const e=f.getUser();return e?this.fleets.filter(t=>t.owner_id===e.id):[]}getPlayerTrades(){const e=f.getUser();return e?this.trades.filter(t=>t.owner_id===e.id):[]}async sendFleet(e,t,s){return await p.sendFleet(e,t,s)}async queueBuilding(e,t){return await p.queueBuilding(e,t)}async createTradeRoute(e,t,s,i){return await p.createTradeRoute(e,t,s,i)}async proposeTreaty(e,t,s){return await p.proposeTreaty(e,t,s)}getPlayerBuildings(){var t;const e=f.getUser();return e?((t=this.buildings)==null?void 0:t.filter(s=>s.owner_id===e.id))||[]:[]}getPlayerBuildingsByType(e){return this.getPlayerBuildings().filter(t=>t.type===e)}}const k=new X,ue=Object.freeze(Object.defineProperty({__proto__:null,GameState:X,gameState:k},Symbol.toStringTag,{value:"Module"}));class me{constructor(e){this.canvas=document.getElementById(e),this.ctx=this.canvas.getContext("2d"),this.systems=[],this.lanes=[],this.fleets=[],this.selectedSystem=null,this.viewX=0,this.viewY=0,this.zoom=1,this.maxZoom=3,this.minZoom=.3,this.colors={background:"#000508",star:"#4080ff",starOwned:"#f1a9ff",starEnemy:"#ff6b6b",starNeutral:"#8cb3ff",lane:"rgba(64, 128, 255, 0.2)",laneActive:"rgba(241, 169, 255, 0.6)",fleet:"#8b5cf6",selection:"#f1a9ff",grid:"rgba(255, 255, 255, 0.02)",nebula:"rgba(139, 92, 246, 0.1)",starGlow:"rgba(64, 128, 255, 0.3)"},this.animationFrame=null,this.lastTime=0,this.setupCanvas(),this.setupEventListeners(),this.startRenderLoop()}setupCanvas(){this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas())}resizeCanvas(){const e=this.canvas.getBoundingClientRect();this.canvas.width=e.width,this.canvas.height=e.height}setupEventListeners(){let e=!1,t=0,s=0;this.canvas.addEventListener("mousedown",i=>{if(i.button===0){const o=this.screenToWorld(i.offsetX,i.offsetY),n=this.getSystemAt(o.x,o.y);n?this.selectSystem(n):(e=!0,t=i.offsetX,s=i.offsetY,this.canvas.style.cursor="grabbing")}}),this.canvas.addEventListener("mousemove",i=>{if(e){const o=i.offsetX-t,n=i.offsetY-s;this.viewX+=o/this.zoom,this.viewY+=n/this.zoom,t=i.offsetX,s=i.offsetY}else{const o=this.screenToWorld(i.offsetX,i.offsetY),n=this.getSystemAt(o.x,o.y);this.showTooltip(n,i.offsetX,i.offsetY)}}),this.canvas.addEventListener("mouseup",i=>{i.button===0&&(e=!1,this.canvas.style.cursor="crosshair")}),this.canvas.addEventListener("contextmenu",i=>{i.preventDefault();const o=this.screenToWorld(i.offsetX,i.offsetY),n=this.getSystemAt(o.x,o.y);n&&this.showContextMenu(n,i.offsetX,i.offsetY)}),this.canvas.addEventListener("wheel",i=>{i.preventDefault();const o=i.deltaY>0?.9:1.1,n=Math.max(this.minZoom,Math.min(this.maxZoom,this.zoom*o));if(n!==this.zoom){const r=this.canvas.getBoundingClientRect(),a=i.clientX-r.left,l=i.clientY-r.top,h=this.screenToWorld(a,l);this.zoom=n;const d=this.screenToWorld(a,l);this.viewX+=h.x-d.x,this.viewY+=h.y-d.y}})}screenToWorld(e,t){return{x:(e-this.canvas.width/2)/this.zoom-this.viewX,y:(t-this.canvas.height/2)/this.zoom-this.viewY}}worldToScreen(e,t){return{x:(e+this.viewX)*this.zoom+this.canvas.width/2,y:(t+this.viewY)*this.zoom+this.canvas.height/2}}getSystemAt(e,t){return this.systems.find(i=>{const o=i.x-e,n=i.y-t;return Math.sqrt(o*o+n*n)<=20})}selectSystem(e){this.selectedSystem=e,this.canvas.dispatchEvent(new CustomEvent("systemSelected",{detail:{system:e}}))}showTooltip(e,t,s){const i=document.getElementById("tooltip");e?(i.innerHTML=`
        <div class="font-semibold">${e.name||`System ${e.id}`}</div>
        <div class="text-xs">
          <div>Position: ${e.x}, ${e.y}</div>
          <div>Population: ${e.pop||0}</div>
          <div>Owner: ${e.owner_name||"Uncolonized"}</div>
        </div>
      `,i.style.left=`${t+10}px`,i.style.top=`${s-10}px`,i.classList.remove("hidden")):i.classList.add("hidden")}showContextMenu(e,t,s){const i=document.getElementById("context-menu");i.style.left=`${t}px`,i.style.top=`${s}px`,i.classList.remove("hidden"),i.dataset.systemId=e.id;const o=n=>{i.contains(n.target)||(i.classList.add("hidden"),document.removeEventListener("click",o))};setTimeout(()=>document.addEventListener("click",o),0)}startRenderLoop(){const e=t=>{const s=t-this.lastTime;this.lastTime=t,this.clear(),this.drawBackground(),this.drawLanes(),this.drawSystems(),this.drawFleets(s),this.drawUI(),this.animationFrame=requestAnimationFrame(e)};this.animationFrame=requestAnimationFrame(e)}clear(){this.ctx.fillStyle=this.colors.background,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}drawBackground(){this.ctx.globalAlpha=.1;const e=Date.now()*1e-4;for(let r=0;r<3;r++){const a=r*150,l=Math.sin(e+r)*200+a,h=Math.cos(e*.7+r)*150+a,d=300+Math.sin(e*.5+r)*50,S=this.ctx.createRadialGradient(l,h,0,l,h,d);S.addColorStop(0,this.colors.nebula),S.addColorStop(.5,"rgba(64, 128, 255, 0.05)"),S.addColorStop(1,"rgba(0, 0, 0, 0)"),this.ctx.fillStyle=S,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}this.ctx.globalAlpha=1,this.ctx.strokeStyle=this.colors.grid,this.ctx.lineWidth=1,this.ctx.globalAlpha=.15;const t=100,s=Math.floor((-this.viewX-this.canvas.width/2/this.zoom)/t)*t,i=Math.ceil((-this.viewX+this.canvas.width/2/this.zoom)/t)*t,o=Math.floor((-this.viewY-this.canvas.height/2/this.zoom)/t)*t,n=Math.ceil((-this.viewY+this.canvas.height/2/this.zoom)/t)*t;this.ctx.beginPath();for(let r=s;r<=i;r+=t){const a=this.worldToScreen(r,0);this.ctx.moveTo(a.x,0),this.ctx.lineTo(a.x,this.canvas.height)}for(let r=o;r<=n;r+=t){const a=this.worldToScreen(0,r);this.ctx.moveTo(0,a.y),this.ctx.lineTo(this.canvas.width,a.y)}this.ctx.stroke(),this.ctx.globalAlpha=1}drawLanes(){this.ctx.strokeStyle=this.colors.lane,this.ctx.lineWidth=2,this.ctx.globalAlpha=.6,this.lanes.forEach(e=>{const t=this.worldToScreen(e.fromX,e.fromY),s=this.worldToScreen(e.toX,e.toY);this.ctx.beginPath(),this.ctx.moveTo(t.x,t.y),this.ctx.lineTo(s.x,s.y),this.ctx.stroke()}),this.ctx.globalAlpha=1}drawSystems(){this.systems.forEach(e=>{const t=this.worldToScreen(e.x,e.y);if(t.x<-50||t.x>this.canvas.width+50||t.y<-50||t.y>this.canvas.height+50)return;let s=this.colors.star;e.owner_id&&(s=this.colors.starOwned);const i=6*this.zoom,o=20*this.zoom,n=this.ctx.createRadialGradient(t.x,t.y,0,t.x,t.y,o);n.addColorStop(0,s+"40"),n.addColorStop(.3,s+"20"),n.addColorStop(1,s+"00"),this.ctx.fillStyle=n,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,o,0,Math.PI*2),this.ctx.fill();const r=this.ctx.createRadialGradient(t.x,t.y,0,t.x,t.y,i);if(r.addColorStop(0,"#ffffff"),r.addColorStop(.7,s),r.addColorStop(1,s+"cc"),this.ctx.fillStyle=r,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,i,0,Math.PI*2),this.ctx.fill(),e.owner_id&&this.zoom>.6&&(this.ctx.strokeStyle=this.colors.starOwned,this.ctx.lineWidth=1,this.ctx.globalAlpha=.8,this.ctx.beginPath(),this.ctx.moveTo(t.x-i*1.5,t.y),this.ctx.lineTo(t.x+i*1.5,t.y),this.ctx.moveTo(t.x,t.y-i*1.5),this.ctx.lineTo(t.x,t.y+i*1.5),this.ctx.stroke(),this.ctx.globalAlpha=1),this.selectedSystem&&this.selectedSystem.id===e.id){const a=Date.now()*.005,l=(12+Math.sin(a)*2)*this.zoom;this.ctx.strokeStyle=this.colors.selection,this.ctx.lineWidth=2,this.ctx.globalAlpha=.8+Math.sin(a)*.2,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,l,0,Math.PI*2),this.ctx.stroke(),this.ctx.globalAlpha=1}if(this.zoom>.8){const a=Math.floor(11*this.zoom);this.ctx.font=`${a}px monospace`,this.ctx.textAlign="center",this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.fillText(e.name||`S${e.id.slice(-3)}`,t.x+1,t.y-15*this.zoom+1),this.ctx.fillStyle="rgba(255, 255, 255, 0.95)",this.ctx.fillText(e.name||`S${e.id.slice(-3)}`,t.x,t.y-15*this.zoom)}if(e.pop>0&&this.zoom>.5){const a=Math.floor(9*this.zoom);this.ctx.font=`${a}px monospace`,this.ctx.textAlign="center",this.ctx.fillStyle="rgba(241, 169, 255, 0.2)",this.ctx.fillRect(t.x-8*this.zoom,t.y+12*this.zoom,16*this.zoom,12*this.zoom),this.ctx.fillStyle="#f1a9ff",this.ctx.fillText(e.pop.toString(),t.x,t.y+21*this.zoom)}})}drawFleets(e){this.fleets.forEach(t=>{const s=this.systems.find(l=>l.id===t.from_id),i=this.systems.find(l=>l.id===t.to_id);if(!s||!i)return;const o=.5,n=s.x+(i.x-s.x)*o,r=s.y+(i.y-s.y)*o,a=this.worldToScreen(n,r);this.ctx.fillStyle=this.colors.fleet,this.ctx.beginPath(),this.ctx.arc(a.x,a.y,4*this.zoom,0,Math.PI*2),this.ctx.fill(),this.zoom>.7&&(this.ctx.fillStyle="#ffffff",this.ctx.font=`${Math.floor(8*this.zoom)}px monospace`,this.ctx.textAlign="center",this.ctx.fillText(t.strength.toString(),a.x,a.y-8*this.zoom))})}drawUI(){this.ctx.fillStyle="#ffffff",this.ctx.font="12px monospace",this.ctx.textAlign="left",this.ctx.fillText(`Zoom: ${(this.zoom*100).toFixed(0)}%`,10,25);const e=this.screenToWorld(this.canvas.width/2,this.canvas.height/2);this.ctx.fillText(`Center: ${e.x.toFixed(0)}, ${e.y.toFixed(0)}`,10,45)}setSystems(e){console.log("MapRenderer: Setting systems",e.length,"systems"),this.systems=e}setLanes(e){this.lanes=e}setFleets(e){this.fleets=e}setSelectedSystem(e){this.selectedSystem=e}centerOnSystem(e){const t=this.systems.find(s=>s.id===e);t&&(this.viewX=-t.x,this.viewY=-t.y)}fitToSystems(){if(this.systems.length===0)return;const e=Math.min(...this.systems.map(d=>d.x)),t=Math.max(...this.systems.map(d=>d.x)),s=Math.min(...this.systems.map(d=>d.y)),i=Math.max(...this.systems.map(d=>d.y)),o=(e+t)/2,n=(s+i)/2;this.viewX=-o,this.viewY=-n;const r=t-e+100,a=i-s+100,l=this.canvas.width/r,h=this.canvas.height/a;this.zoom=Math.min(l,h,this.maxZoom)}destroy(){this.animationFrame&&cancelAnimationFrame(this.animationFrame)}}const pe="modulepreload",fe=function(c){return"/"+c},j={},L=function(e,t,s){let i=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const n=document.querySelector("meta[property=csp-nonce]"),r=(n==null?void 0:n.nonce)||(n==null?void 0:n.getAttribute("nonce"));i=Promise.allSettled(t.map(a=>{if(a=fe(a),a in j)return;j[a]=!0;const l=a.endsWith(".css"),h=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${a}"]${h}`))return;const d=document.createElement("link");if(d.rel=l?"stylesheet":pe,l||(d.as="script"),d.crossOrigin="",d.href=a,r&&d.setAttribute("nonce",r),document.head.appendChild(d),l)return new Promise((S,x)=>{d.addEventListener("load",S),d.addEventListener("error",()=>x(new Error(`Unable to preload CSS for ${a}`)))})}))}function o(n){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=n,window.dispatchEvent(r),!r.defaultPrevented)throw n}return i.then(n=>{for(const r of n||[])r.status==="rejected"&&o(r.reason);return e().catch(o)})};class ye{constructor(){this.currentUser=null,this.gameState=null,this.tickTimer=null}updateAuthUI(e){this.currentUser=e;const t=document.getElementById("login-btn"),s=document.getElementById("user-info"),i=document.getElementById("username");e?(t.classList.add("hidden"),s.classList.remove("hidden"),i.textContent=e.username):(t.classList.remove("hidden"),s.classList.add("hidden"),i.textContent="")}updateGameUI(e){this.gameState=e,this.updateResourcesUI(e.playerResources),this.updateSystemInfoUI(e.selectedSystem),this.updateGameStatusUI(e)}updateResourcesUI(e){var s;document.getElementById("credits").textContent=e.credits.toLocaleString(),document.getElementById("food").textContent=e.food.toLocaleString(),document.getElementById("ore").textContent=e.ore.toLocaleString(),document.getElementById("goods").textContent=e.goods.toLocaleString(),document.getElementById("fuel").textContent=e.fuel.toLocaleString();const t=document.getElementById("credit-income");((s=this.gameState)==null?void 0:s.creditIncome)>0?(t.textContent=`(+${this.gameState.creditIncome}/tick)`,t.style.display="inline"):t.style.display="none"}updateSystemInfoUI(e){const t=document.getElementById("selected-system");if(e){const s=this.currentUser&&e.owner_id===this.currentUser.id;t.innerHTML=`
        <div class="space-y-2">
          <div class="font-semibold text-orange-300">${e.name||`System ${e.id.slice(-3)}`}</div>
          <div class="text-xs space-y-1">
            <div>Position: ${e.x}, ${e.y}</div>
            <div>Population: ${e.pop||0}</div>
            <div>Morale: ${e.morale||0}%</div>
            <div>Owner: ${e.owner_name||"Uncolonized"}</div>
          </div>
          
          <div class="text-xs space-y-1 pt-2 border-t border-space-600">
            <div class="font-medium">Planets:</div>
            <div id="planets-loading" class="text-space-400">Loading planets...</div>
          </div>
          
          ${s?`
            <div class="text-xs space-y-1 pt-2 border-t border-space-600">
              <div class="font-medium">Resources:</div>
              <div>Food: ${e.food||0}</div>
              <div>Ore: ${e.ore||0}</div>
              <div>Goods: ${e.goods||0}</div>
              <div>Fuel: ${e.fuel||0}</div>
            </div>
            <div class="text-xs space-y-1 pt-2 border-t border-space-600">
              <div class="font-medium">Buildings:</div>
              <div>Habitat: Lvl ${e.hab_lvl||0}</div>
              <div>Farm: Lvl ${e.farm_lvl||0}</div>
              <div>Mine: Lvl ${e.mine_lvl||0}</div>
              <div>Factory: Lvl ${e.fac_lvl||0}</div>
              <div>Shipyard: Lvl ${e.yard_lvl||0}</div>
            </div>
          `:""}
        </div>
      `,this.loadSystemPlanets(e.id)}else t.innerHTML="Click a system to view details"}async loadSystemPlanets(e){try{const{pb:t}=await L(async()=>{const{pb:n}=await Promise.resolve().then(()=>R);return{pb:n}},void 0),s=await t.collection("planets").getFullList({filter:`system_id = "${e}"`,expand:"planet_type"}),i=document.getElementById("planets-loading");if(!i)return;if(s.length===0){i.innerHTML='<div class="text-space-400">No planets in this system</div>';return}const o=s.map(n=>{var h,d;const r=n.colonized_by&&n.colonized_by!=="",a=((d=(h=n.expand)==null?void 0:h.planet_type)==null?void 0:d.name)||"Unknown",l=r&&this.currentUser&&n.colonized_by===this.currentUser.id;return`
          <div class="p-2 bg-space-800 rounded mb-1 cursor-pointer hover:bg-space-700" 
               onclick="window.uiController.selectPlanet('${n.id}')">
            <div class="font-medium text-space-200">${n.name}</div>
            <div class="text-xs text-space-400">${a} • Size ${n.size}</div>
            <div class="text-xs ${r?l?"text-emerald-400":"text-red-400":"text-space-300"}">
              ${r?l?"Your Colony":"Colonized":"Uncolonized"}
            </div>
          </div>
        `}).join("");i.innerHTML=o,window.uiController=this}catch(t){console.error("Error loading planets:",t);const s=document.getElementById("planets-loading");s&&(s.innerHTML='<div class="text-red-400">Failed to load planets</div>')}}selectPlanet(e){L(async()=>{const{pb:t}=await Promise.resolve().then(()=>R);return{pb:t}},void 0).then(({pb:t})=>{t.collection("planets").getOne(e,{expand:"planet_type,system_id"}).then(s=>{!s.colonized_by||s.colonized_by===""?this.showPlanetColonizeModal(s):this.showPlanetInfo(s)}).catch(s=>{console.error("Error fetching planet:",s),this.showError("Failed to load planet information")})})}showPlanetColonizeModal(e){var s,i;if(!this.currentUser){this.showError("Please log in to colonize planets");return}const t=((i=(s=e.expand)==null?void 0:s.planet_type)==null?void 0:i.name)||"Unknown";this.showModal(`Colonize ${e.name}`,`
      <div class="space-y-4">
        <div class="p-3 bg-space-800 rounded">
          <div class="font-semibold text-emerald-300">${e.name}</div>
          <div class="text-sm text-space-300">Type: ${t}</div>
          <div class="text-sm text-space-300">Size: ${e.size}</div>
          <div class="text-sm text-emerald-400">Available for colonization</div>
        </div>
        
        <div class="text-sm text-space-300">
          Establishing a colony will:
          <ul class="list-disc list-inside mt-2 space-y-1">
            <li>Create an initial population of 100</li>
            <li>Build a basic command center</li>
            <li>Start resource production</li>
          </ul>
        </div>
        
        <div class="flex space-x-2">
          <button class="flex-1 px-4 py-2 bg-emerald-700 hover:bg-emerald-600 rounded" 
                  onclick="window.uiController.colonizePlanet('${e.id}')">
            Colonize Planet
          </button>
          <button class="flex-1 px-4 py-2 bg-space-700 hover:bg-space-600 rounded" 
                  onclick="window.uiController.hideModal()">
            Cancel
          </button>
        </div>
      </div>
    `)}showPlanetInfo(e){var i,o;const t=((o=(i=e.expand)==null?void 0:i.planet_type)==null?void 0:o.name)||"Unknown",s=this.currentUser&&e.colonized_by===this.currentUser.id;this.showModal(`${e.name} Information`,`
      <div class="space-y-4">
        <div class="p-3 bg-space-800 rounded">
          <div class="font-semibold text-orange-300">${e.name}</div>
          <div class="text-sm text-space-300">Type: ${t}</div>
          <div class="text-sm text-space-300">Size: ${e.size}</div>
          <div class="text-sm ${s?"text-emerald-400":"text-red-400"}">
            ${s?"Your Colony":"Colonized by another player"}
          </div>
        </div>
        
        ${s?`
          <div class="text-sm text-space-300">
            This is one of your colonies. You can manage it through the buildings and resources panels.
          </div>
        `:`
          <div class="text-sm text-space-300">
            This planet has already been colonized by another player.
          </div>
        `}
        
        <button class="w-full px-4 py-2 bg-space-700 hover:bg-space-600 rounded" 
                onclick="window.uiController.hideModal()">
          Close
        </button>
      </div>
    `)}updateGameStatusUI(e){const t=document.getElementById("current-turn"),s=t.textContent,i=`Tick ${e.currentTick}`;t.textContent=i,s!==i&&(t.style.animation="none",t.offsetHeight,t.style.animation="flash 0.5s ease-out"),document.getElementById("player-count").textContent=e.systems.filter(r=>r.owner_id).length;const o=e.ticksPerMinute||6,n=Math.round(60/o);document.getElementById("next-tick").textContent=`${o}/min (${n}s)`}startTickTimer(e){this.tickTimer&&clearInterval(this.tickTimer);const t=()=>{const i=e-new Date;if(i<=0){document.getElementById("next-tick").textContent="Processing...",clearInterval(this.tickTimer);return}const o=Math.floor(i/6e4),n=Math.floor(i%6e4/1e3);document.getElementById("next-tick").textContent=`${o}:${n.toString().padStart(2,"0")}`};t(),this.tickTimer=setInterval(t,1e3)}showModal(e,t){const s=document.getElementById("modal-overlay"),i=document.getElementById("modal-content");i.innerHTML=`
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">${e}</h2>
        <button id="modal-close" class="text-space-400 hover:text-space-200">&times;</button>
      </div>
      ${t}
    `,s.classList.remove("hidden"),document.getElementById("modal-close").addEventListener("click",()=>{this.hideModal()})}hideModal(){document.getElementById("modal-overlay").classList.add("hidden")}showError(e){this.showModal("Error",`
      <div class="text-red-400 mb-4">${e}</div>
      <button class="w-full px-4 py-2 bg-space-700 hover:bg-space-600 rounded" onclick="document.getElementById('modal-overlay').classList.add('hidden')">
        OK
      </button>
    `)}showBuildModal(e){const s=[{type:"habitat",name:"Habitat",cost:100,description:"Increases population capacity"},{type:"farm",name:"Farm",cost:150,description:"Produces food"},{type:"mine",name:"Mine",cost:200,description:"Produces ore"},{type:"factory",name:"Factory",cost:300,description:"Produces goods"},{type:"shipyard",name:"Shipyard",cost:500,description:"Enables fleet construction"},{type:"bank",name:"Bank",cost:1e3,description:"Generates 1 credit per tick"}].map(i=>`
      <button class="w-full p-3 bg-space-700 hover:bg-space-600 rounded mb-2 text-left" 
              onclick="window.gameState.queueBuilding('${e.id}', '${i.type}')">
        <div class="font-semibold">${i.name}</div>
        <div class="text-sm text-space-300">${i.description}</div>
        <div class="text-sm text-green-400">Cost: ${i.cost} credits</div>
      </button>
    `).join("");this.showModal(`Build in ${e.name||`System ${e.id.slice(-3)}`}`,`
      <div class="space-y-2">
        ${s}
      </div>
    `)}showSendFleetModal(e){var i;const t=((i=this.gameState)==null?void 0:i.getOwnedSystems())||[];if(t.length===0){this.showError("You need to own at least one system to send fleets");return}const s=t.map(o=>`<option value="${o.id}">${o.name||`System ${o.id.slice(-3)}`}</option>`).join("");this.showModal("Send Fleet",`
      <form id="fleet-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">From System:</label>
          <select id="from-system" class="w-full p-2 bg-space-700 border border-space-600 rounded">
            ${s}
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">To System:</label>
          <input type="text" id="to-system" value="${e.name||`System ${e.id.slice(-3)}`}" 
                 class="w-full p-2 bg-space-700 border border-space-600 rounded" readonly>
          <input type="hidden" id="to-system-id" value="${e.id}">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Fleet Strength:</label>
          <input type="number" id="fleet-strength" min="1" max="100" value="10"
                 class="w-full p-2 bg-space-700 border border-space-600 rounded">
        </div>
        <div class="flex space-x-2">
          <button type="submit" class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-500 rounded">
            Send Fleet
          </button>
          <button type="button" onclick="document.getElementById('modal-overlay').classList.add('hidden')"
                  class="flex-1 px-4 py-2 bg-space-700 hover:bg-space-600 rounded">
            Cancel
          </button>
        </div>
      </form>
    `),document.getElementById("fleet-form").addEventListener("submit",async o=>{o.preventDefault();try{const n=document.getElementById("from-system").value,r=document.getElementById("to-system-id").value,a=parseInt(document.getElementById("fleet-strength").value);await this.gameState.sendFleet(n,r,a),this.hideModal()}catch(n){this.showError(`Failed to send fleet: ${n.message}`)}})}showTradeRouteModal(e){var n;const t=((n=this.gameState)==null?void 0:n.getOwnedSystems())||[];if(t.length===0){this.showError("You need to own at least one system to create trade routes");return}const s=t.map(r=>`<option value="${r.id}">${r.name||`System ${r.id.slice(-3)}`}</option>`).join(""),o=["food","ore","goods","fuel"].map(r=>`<option value="${r}">${r.charAt(0).toUpperCase()+r.slice(1)}</option>`).join("");this.showModal("Create Trade Route",`
      <form id="trade-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">From System:</label>
          <select id="trade-from-system" class="w-full p-2 bg-space-700 border border-space-600 rounded">
            ${s}
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">To System:</label>
          <input type="text" value="${e.name||`System ${e.id.slice(-3)}`}" 
                 class="w-full p-2 bg-space-700 border border-space-600 rounded" readonly>
          <input type="hidden" id="trade-to-system-id" value="${e.id}">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Cargo Type:</label>
          <select id="cargo-type" class="w-full p-2 bg-space-700 border border-space-600 rounded">
            ${o}
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Cargo Capacity:</label>
          <input type="number" id="cargo-capacity" min="1" max="1000" value="100"
                 class="w-full p-2 bg-space-700 border border-space-600 rounded">
        </div>
        <div class="flex space-x-2">
          <button type="submit" class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-500 rounded">
            Create Route
          </button>
          <button type="button" onclick="document.getElementById('modal-overlay').classList.add('hidden')"
                  class="flex-1 px-4 py-2 bg-space-700 hover:bg-space-600 rounded">
            Cancel
          </button>
        </div>
      </form>
    `),document.getElementById("trade-form").addEventListener("submit",async r=>{r.preventDefault();try{const a=document.getElementById("trade-from-system").value,l=document.getElementById("trade-to-system-id").value,h=document.getElementById("cargo-type").value,d=parseInt(document.getElementById("cargo-capacity").value);await this.gameState.createTradeRoute(a,l,h,d),this.hideModal()}catch(a){this.showError(`Failed to create trade route: ${a.message}`)}})}showFleetPanel(){var s;const e=((s=this.gameState)==null?void 0:s.getPlayerFleets())||[],t=e.length>0?e.map(i=>`
      <div class="bg-space-700 p-3 rounded mb-2">
        <div class="font-semibold">Fleet ${i.id.slice(-3)}</div>
        <div class="text-sm text-space-300">
          <div>From: ${i.from_name||i.from_id}</div>
          <div>To: ${i.to_name||i.to_id}</div>
          <div>Strength: ${i.strength}</div>
          <div>ETA: ${i.eta_tick?`Tick ${i.eta_tick}`:"Unknown"}</div>
        </div>
      </div>
    `).join(""):'<div class="text-space-400">No fleets in transit</div>';this.showModal("Your Fleets",t)}showTradePanel(){var s;const e=((s=this.gameState)==null?void 0:s.getPlayerTrades())||[],t=e.length>0?e.map(i=>`
      <div class="bg-space-700 p-3 rounded mb-2">
        <div class="font-semibold">Trade Route ${i.id.slice(-3)}</div>
        <div class="text-sm text-space-300">
          <div>From: ${i.from_name||i.from_id}</div>
          <div>To: ${i.to_name||i.to_id}</div>
          <div>Cargo: ${i.cargo}</div>
          <div>Capacity: ${i.cap}</div>
          <div>ETA: ${i.eta_tick?`Tick ${i.eta_tick}`:"Unknown"}</div>
        </div>
      </div>
    `).join(""):'<div class="text-space-400">No active trade routes</div>';this.showModal("Your Trade Routes",t)}showDiplomacyPanel(){this.showModal("Diplomacy",`
      <div class="text-center text-space-400 py-8">
        Diplomacy features coming soon!
      </div>
    `)}showBuildingsPanel(){var r;const e=((r=this.gameState)==null?void 0:r.getPlayerBuildings())||[],t=e.filter(a=>a.type==="bank"),s=t.reduce((a,l)=>a+(l.credits_per_tick||1),0),i=e.reduce((a,l)=>(a[l.type]||(a[l.type]=[]),a[l.type].push(l),a),{}),o={habitat:"Habitats",farm:"Farms",mine:"Mines",factory:"Factories",shipyard:"Shipyards",bank:"Banks"},n=Object.entries(i).map(([a,l])=>`
      <div class="mb-4">
        <h3 class="text-lg font-semibold text-plasma-300 mb-2">${o[a]||a} (${l.length})</h3>
        <div class="space-y-2">
          ${l.map(h=>{var d;return`
            <div class="bg-space-700 p-3 rounded">
              <div class="font-semibold text-nebula-300">${h.name||`${((d=o[a])==null?void 0:d.slice(0,-1))||a}-${h.id.slice(-3)}`}</div>
              <div class="text-sm text-space-300">
                <div>System: ${h.system_name||h.system_id}</div>
                ${h.type==="bank"?`<div class="text-nebula-300">Income: ${h.credits_per_tick||1} credits/tick</div>`:""}
                <div class="text-xs ${h.active!==!1?"text-green-400":"text-red-400"}">
                  ${h.active!==!1?"Active":"Inactive"}
                </div>
              </div>
            </div>
          `}).join("")}
        </div>
      </div>
    `).join("");this.showModal("Buildings Overview",`
      ${t.length>0?`
        <div class="mb-4 p-3 bg-space-800 rounded">
          <div class="text-lg font-semibold text-plasma-300">Credit Income: ${s} credits/tick</div>
          <div class="text-sm text-space-400">${s*6} credits/minute • ${s*360} credits/hour</div>
        </div>
      `:""}
      
      ${n||'<div class="text-space-400 text-center py-8">No buildings constructed</div>'}
      
      <div class="mt-4 text-xs text-space-400 border-t border-space-600 pt-2">
        💡 Build structures at your systems to improve production and defense
      </div>
    `)}showColonizeModal(e){if(!this.currentUser){this.showError("Please log in to colonize planets");return}L(async()=>{const{pb:t}=await Promise.resolve().then(()=>R);return{pb:t}},void 0).then(({pb:t})=>{t.collection("planets").getFullList({filter:`system_id = "${e.id}"`,expand:"planet_type"}).then(s=>{if(s.length===0){this.showError("No planets found in this system");return}const i=s.map(o=>{var a,l;const n=o.colonized_by!=null&&o.colonized_by!=="",r=((l=(a=o.expand)==null?void 0:a.planet_type)==null?void 0:l.name)||"Unknown";return`
            <div class="p-3 bg-space-700 rounded mb-2 ${n?"opacity-50":"hover:bg-space-600 cursor-pointer"}" 
                 ${n?"":`onclick="window.uiController.colonizePlanet('${o.id}')"`}>
              <div class="font-semibold">${o.name}</div>
              <div class="text-sm text-space-300">Type: ${r}</div>
              <div class="text-sm text-space-300">Size: ${o.size}</div>
              ${n?'<div class="text-sm text-red-400">Already colonized</div>':'<div class="text-sm text-emerald-400">Available for colonization</div>'}
            </div>
          `}).join("");this.showModal(`Colonize Planet in ${e.name||`System ${e.id.slice(-3)}`}`,`
          <div class="space-y-2">
            <div class="text-sm text-space-300 mb-4">
              Select a planet to establish a new colony:
            </div>
            ${i}
          </div>
        `),window.uiController=this}).catch(s=>{console.error("Error fetching planets:",s),this.showError("Failed to load planets in this system")})})}async colonizePlanet(e){try{const{pb:t}=await L(async()=>{const{pb:o}=await Promise.resolve().then(()=>R);return{pb:o}},void 0),s=await fetch(`${t.baseUrl}/api/orders/colonize`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:t.authStore.token},body:JSON.stringify({planet_id:e})}),i=await s.json();if(s.ok&&i.success){this.hideModal(),this.showSuccessMessage("Planet colonized successfully! Your new colony has been established.");const{gameState:o}=await L(async()=>{const{gameState:n}=await Promise.resolve().then(()=>ue);return{gameState:n}},void 0);o.refreshData()}else throw new Error(i.error||"Failed to colonize planet")}catch(t){console.error("Colonization error:",t),this.showError(`Failed to colonize planet: ${t.message}`)}}showSuccessMessage(e){this.showModal("Success",`
      <div class="text-emerald-400 mb-4">${e}</div>
      <button class="w-full px-4 py-2 bg-space-700 hover:bg-space-600 rounded" onclick="document.getElementById('modal-overlay').classList.add('hidden')">
        OK
      </button>
    `)}}class ge{constructor(){this.mapRenderer=null,this.uiController=null,this.init()}async init(){console.log("Initializing Xan Nation..."),this.uiController=new ye,this.mapRenderer=new me("game-canvas"),f.subscribe(e=>{this.handleAuthChange(e)}),k.subscribe(e=>{this.handleGameStateChange(e)}),this.setupEventListeners(),console.log("Xan Nation initialized")}handleAuthChange(e){this.uiController.updateAuthUI(e),e?console.log("User logged in:",e.username):console.log("User logged out")}handleGameStateChange(e){this.mapRenderer&&(this.mapRenderer.setSystems(e.systems),this.mapRenderer.setFleets(e.fleets),this.mapRenderer.setSelectedSystem(e.selectedSystem),e.mapData&&e.mapData.lanes&&this.mapRenderer.setLanes(e.mapData.lanes),e.systems.length>0&&!this.mapRenderer.hasInitialFit&&(this.mapRenderer.fitToSystems(),this.mapRenderer.hasInitialFit=!0)),this.uiController.updateGameUI(e)}setupEventListeners(){const e=document.getElementById("game-canvas");e.addEventListener("systemSelected",i=>{k.selectSystem(i.detail.system.id)});const t=document.getElementById("context-menu");t.addEventListener("click",i=>{const o=i.target.dataset.action,n=t.dataset.systemId;o&&n&&(this.handleContextMenuAction(o,n),t.classList.add("hidden"))}),e.addEventListener("mouseleave",()=>{document.getElementById("tooltip").classList.add("hidden")}),document.getElementById("fleet-btn").addEventListener("click",()=>{this.uiController.showFleetPanel()}),document.getElementById("trade-btn").addEventListener("click",()=>{this.uiController.showTradePanel()}),document.getElementById("diplo-btn").addEventListener("click",()=>{this.uiController.showDiplomacyPanel()}),document.getElementById("buildings-btn").addEventListener("click",()=>{this.uiController.showBuildingsPanel()}),document.getElementById("login-btn").addEventListener("click",()=>{this.handleLogin()}),document.getElementById("logout-btn").addEventListener("click",()=>{this.handleLogout()}),document.getElementById("build-btn").addEventListener("click",()=>{this.handleBuildAction()}),document.getElementById("send-fleet-btn").addEventListener("click",()=>{this.handleSendFleetAction()}),document.getElementById("trade-route-btn").addEventListener("click",()=>{this.handleTradeRouteAction()}),document.getElementById("colonize-btn").addEventListener("click",()=>{this.handleColonizeAction()}),document.addEventListener("keydown",i=>{this.handleKeyboardInput(i)});const s=document.getElementById("modal-overlay");s.addEventListener("click",i=>{i.target===s&&this.uiController.hideModal()})}async handleLogin(){try{await f.loginWithDiscord()}catch(e){console.error("Login failed:",e),this.uiController.showError("Login failed. Please try again.")}}handleLogout(){f.logout()}handleContextMenuAction(e,t){const s=k.systems.find(i=>i.id===t);if(s)switch(e){case"view":k.selectSystem(t),this.mapRenderer.centerOnSystem(t);break;case"fleet":this.uiController.showSendFleetModal(s);break;case"trade":this.uiController.showTradeRouteModal(s);break;case"colonize":this.uiController.showColonizeModal(s);break}}handleBuildAction(){const e=k.getSelectedSystem();if(!e){this.uiController.showError("Please select a system first");return}if(!f.isLoggedIn()){this.uiController.showError("Please log in first");return}this.uiController.showBuildModal(e)}handleSendFleetAction(){const e=k.getSelectedSystem();if(!e){this.uiController.showError("Please select a system first");return}if(!f.isLoggedIn()){this.uiController.showError("Please log in first");return}this.uiController.showSendFleetModal(e)}handleTradeRouteAction(){const e=k.getSelectedSystem();if(!e){this.uiController.showError("Please select a system first");return}if(!f.isLoggedIn()){this.uiController.showError("Please log in first");return}this.uiController.showTradeRouteModal(e)}handleColonizeAction(){const e=k.getSelectedSystem();if(!e){this.uiController.showError("Please select a system first");return}if(!f.isLoggedIn()){this.uiController.showError("Please log in first");return}this.uiController.showColonizeModal(e)}handleKeyboardInput(e){if(!(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"))switch(e.key.toLowerCase()){case"escape":this.uiController.hideModal(),document.getElementById("context-menu").classList.add("hidden");break;case"f":this.handleSendFleetAction();break;case"t":this.handleTradeRouteAction();break;case"b":this.handleBuildAction();break;case"c":k.getSelectedSystem()&&this.mapRenderer.centerOnSystem(k.getSelectedSystem().id);break;case"o":this.handleColonizeAction();break;case"h":this.mapRenderer.fitToSystems();break}}}new ge;
