(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();class b extends Error{constructor(t){var e,i,s,n;super("ClientResponseError"),this.url="",this.status=0,this.response={},this.isAbort=!1,this.originalError=null,Object.setPrototypeOf(this,b.prototype),t!==null&&typeof t=="object"&&(this.url=typeof t.url=="string"?t.url:"",this.status=typeof t.status=="number"?t.status:0,this.isAbort=!!t.isAbort,this.originalError=t.originalError,t.response!==null&&typeof t.response=="object"?this.response=t.response:t.data!==null&&typeof t.data=="object"?this.response=t.data:this.response={}),this.originalError||t instanceof b||(this.originalError=t),typeof DOMException<"u"&&t instanceof DOMException&&(this.isAbort=!0),this.name="ClientResponseError "+this.status,this.message=(e=this.response)==null?void 0:e.message,this.message||(this.isAbort?this.message="The request was autocancelled. You can find more info in https://github.com/pocketbase/js-sdk#auto-cancellation.":(n=(s=(i=this.originalError)==null?void 0:i.cause)==null?void 0:s.message)!=null&&n.includes("ECONNREFUSED ::1")?this.message="Failed to connect to the PocketBase server. Try changing the SDK URL from localhost to 127.0.0.1 (https://github.com/pocketbase/js-sdk/issues/21).":this.message="Something went wrong while processing your request.")}get data(){return this.response}toJSON(){return{...this}}}const L=/^[\u0009\u0020-\u007e\u0080-\u00ff]+$/;function W(c,t){const e={};if(typeof c!="string")return e;const i=Object.assign({},{}).decode||D;let s=0;for(;s<c.length;){const n=c.indexOf("=",s);if(n===-1)break;let o=c.indexOf(";",s);if(o===-1)o=c.length;else if(o<n){s=c.lastIndexOf(";",n-1)+1;continue}const r=c.slice(s,n).trim();if(e[r]===void 0){let a=c.slice(n+1,o).trim();a.charCodeAt(0)===34&&(a=a.slice(1,-1));try{e[r]=i(a)}catch{e[r]=a}}s=o+1}return e}function F(c,t,e){const i=Object.assign({},e||{}),s=i.encode||K;if(!L.test(c))throw new TypeError("argument name is invalid");const n=s(t);if(n&&!L.test(n))throw new TypeError("argument val is invalid");let o=c+"="+n;if(i.maxAge!=null){const r=i.maxAge-0;if(isNaN(r)||!isFinite(r))throw new TypeError("option maxAge is invalid");o+="; Max-Age="+Math.floor(r)}if(i.domain){if(!L.test(i.domain))throw new TypeError("option domain is invalid");o+="; Domain="+i.domain}if(i.path){if(!L.test(i.path))throw new TypeError("option path is invalid");o+="; Path="+i.path}if(i.expires){if(!function(a){return Object.prototype.toString.call(a)==="[object Date]"||a instanceof Date}(i.expires)||isNaN(i.expires.valueOf()))throw new TypeError("option expires is invalid");o+="; Expires="+i.expires.toUTCString()}if(i.httpOnly&&(o+="; HttpOnly"),i.secure&&(o+="; Secure"),i.priority)switch(typeof i.priority=="string"?i.priority.toLowerCase():i.priority){case"low":o+="; Priority=Low";break;case"medium":o+="; Priority=Medium";break;case"high":o+="; Priority=High";break;default:throw new TypeError("option priority is invalid")}if(i.sameSite)switch(typeof i.sameSite=="string"?i.sameSite.toLowerCase():i.sameSite){case!0:o+="; SameSite=Strict";break;case"lax":o+="; SameSite=Lax";break;case"strict":o+="; SameSite=Strict";break;case"none":o+="; SameSite=None";break;default:throw new TypeError("option sameSite is invalid")}return o}function D(c){return c.indexOf("%")!==-1?decodeURIComponent(c):c}function K(c){return encodeURIComponent(c)}const G=typeof navigator<"u"&&navigator.product==="ReactNative"||typeof global<"u"&&global.HermesInternal;let U;function I(c){if(c)try{const t=decodeURIComponent(U(c.split(".")[1]).split("").map(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(t)||{}}catch{}return{}}function _(c,t=0){let e=I(c);return!(Object.keys(e).length>0&&(!e.exp||e.exp-t>Date.now()/1e3))}U=typeof atob!="function"||G?c=>{let t=String(c).replace(/=+$/,"");if(t.length%4==1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(var e,i,s=0,n=0,o="";i=t.charAt(n++);~i&&(e=s%4?64*e+i:i,s++%4)?o+=String.fromCharCode(255&e>>(-2*s&6)):0)i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(i);return o}:atob;const B="pb_auth";class Y{constructor(){this.baseToken="",this.baseModel=null,this._onChangeCallbacks=[]}get token(){return this.baseToken}get model(){return this.baseModel}get isValid(){return!_(this.token)}get isAdmin(){return I(this.token).type==="admin"}get isAuthRecord(){return I(this.token).type==="authRecord"}save(t,e){this.baseToken=t||"",this.baseModel=e||null,this.triggerChange()}clear(){this.baseToken="",this.baseModel=null,this.triggerChange()}loadFromCookie(t,e=B){const i=W(t||"")[e]||"";let s={};try{s=JSON.parse(i),(typeof s===null||typeof s!="object"||Array.isArray(s))&&(s={})}catch{}this.save(s.token||"",s.model||null)}exportToCookie(t,e=B){var a,l;const i={secure:!0,sameSite:!0,httpOnly:!0,path:"/"},s=I(this.token);i.expires=s!=null&&s.exp?new Date(1e3*s.exp):new Date("1970-01-01"),t=Object.assign({},i,t);const n={token:this.token,model:this.model?JSON.parse(JSON.stringify(this.model)):null};let o=F(e,JSON.stringify(n),t);const r=typeof Blob<"u"?new Blob([o]).size:o.length;if(n.model&&r>4096){n.model={id:(a=n==null?void 0:n.model)==null?void 0:a.id,email:(l=n==null?void 0:n.model)==null?void 0:l.email};const u=["collectionId","username","verified"];for(const d in this.model)u.includes(d)&&(n.model[d]=this.model[d]);o=F(e,JSON.stringify(n),t)}return o}onChange(t,e=!1){return this._onChangeCallbacks.push(t),e&&t(this.token,this.model),()=>{for(let i=this._onChangeCallbacks.length-1;i>=0;i--)if(this._onChangeCallbacks[i]==t)return delete this._onChangeCallbacks[i],void this._onChangeCallbacks.splice(i,1)}}triggerChange(){for(const t of this._onChangeCallbacks)t&&t(this.token,this.model)}}class X extends Y{constructor(t="pocketbase_auth"){super(),this.storageFallback={},this.storageKey=t,this._bindStorageEvent()}get token(){return(this._storageGet(this.storageKey)||{}).token||""}get model(){return(this._storageGet(this.storageKey)||{}).model||null}save(t,e){this._storageSet(this.storageKey,{token:t,model:e}),super.save(t,e)}clear(){this._storageRemove(this.storageKey),super.clear()}_storageGet(t){if(typeof window<"u"&&(window!=null&&window.localStorage)){const e=window.localStorage.getItem(t)||"";try{return JSON.parse(e)}catch{return e}}return this.storageFallback[t]}_storageSet(t,e){if(typeof window<"u"&&(window!=null&&window.localStorage)){let i=e;typeof e!="string"&&(i=JSON.stringify(e)),window.localStorage.setItem(t,i)}else this.storageFallback[t]=e}_storageRemove(t){var e;typeof window<"u"&&(window!=null&&window.localStorage)&&((e=window.localStorage)==null||e.removeItem(t)),delete this.storageFallback[t]}_bindStorageEvent(){typeof window<"u"&&(window!=null&&window.localStorage)&&window.addEventListener&&window.addEventListener("storage",t=>{if(t.key!=this.storageKey)return;const e=this._storageGet(this.storageKey)||{};super.save(e.token||"",e.model||null)})}}class T{constructor(t){this.client=t}}class H extends T{async getAll(t){return t=Object.assign({method:"GET"},t),this.client.send("/api/settings",t)}async update(t,e){return e=Object.assign({method:"PATCH",body:t},e),this.client.send("/api/settings",e)}async testS3(t="storage",e){return e=Object.assign({method:"POST",body:{filesystem:t}},e),this.client.send("/api/settings/test/s3",e).then(()=>!0)}async testEmail(t,e,i){return i=Object.assign({method:"POST",body:{email:t,template:e}},i),this.client.send("/api/settings/test/email",i).then(()=>!0)}async generateAppleClientSecret(t,e,i,s,n,o){return o=Object.assign({method:"POST",body:{clientId:t,teamId:e,keyId:i,privateKey:s,duration:n}},o),this.client.send("/api/settings/apple/generate-client-secret",o)}}class A extends T{decode(t){return t}async getFullList(t,e){if(typeof t=="number")return this._getFullList(t,e);let i=500;return(e=Object.assign({},t,e)).batch&&(i=e.batch,delete e.batch),this._getFullList(i,e)}async getList(t=1,e=30,i){return(i=Object.assign({method:"GET"},i)).query=Object.assign({page:t,perPage:e},i.query),this.client.send(this.baseCrudPath,i).then(s=>{var n;return s.items=((n=s.items)==null?void 0:n.map(o=>this.decode(o)))||[],s})}async getFirstListItem(t,e){return(e=Object.assign({requestKey:"one_by_filter_"+this.baseCrudPath+"_"+t},e)).query=Object.assign({filter:t,skipTotal:1},e.query),this.getList(1,1,e).then(i=>{var s;if(!((s=i==null?void 0:i.items)!=null&&s.length))throw new b({status:404,response:{code:404,message:"The requested resource wasn't found.",data:{}}});return i.items[0]})}async getOne(t,e){if(!t)throw new b({url:this.client.buildUrl(this.baseCrudPath+"/"),status:404,response:{code:404,message:"Missing required record id.",data:{}}});return e=Object.assign({method:"GET"},e),this.client.send(this.baseCrudPath+"/"+encodeURIComponent(t),e).then(i=>this.decode(i))}async create(t,e){return e=Object.assign({method:"POST",body:t},e),this.client.send(this.baseCrudPath,e).then(i=>this.decode(i))}async update(t,e,i){return i=Object.assign({method:"PATCH",body:e},i),this.client.send(this.baseCrudPath+"/"+encodeURIComponent(t),i).then(s=>this.decode(s))}async delete(t,e){return e=Object.assign({method:"DELETE"},e),this.client.send(this.baseCrudPath+"/"+encodeURIComponent(t),e).then(()=>!0)}_getFullList(t=500,e){(e=e||{}).query=Object.assign({skipTotal:1},e.query);let i=[],s=async n=>this.getList(n,t||500,e).then(o=>{const r=o.items;return i=i.concat(r),r.length==o.perPage?s(n+1):i});return s(1)}}function g(c,t,e,i){const s=i!==void 0;return s||e!==void 0?s?(console.warn(c),t.body=Object.assign({},t.body,e),t.query=Object.assign({},t.query,i),t):Object.assign(t,e):t}function R(c){var t;(t=c._resetAutoRefresh)==null||t.call(c)}class J extends A{get baseCrudPath(){return"/api/admins"}async update(t,e,i){return super.update(t,e,i).then(s=>{var n,o;return((n=this.client.authStore.model)==null?void 0:n.id)===s.id&&((o=this.client.authStore.model)==null?void 0:o.collectionId)===void 0&&this.client.authStore.save(this.client.authStore.token,s),s})}async delete(t,e){return super.delete(t,e).then(i=>{var s,n;return i&&((s=this.client.authStore.model)==null?void 0:s.id)===t&&((n=this.client.authStore.model)==null?void 0:n.collectionId)===void 0&&this.client.authStore.clear(),i})}authResponse(t){const e=this.decode((t==null?void 0:t.admin)||{});return t!=null&&t.token&&(t!=null&&t.admin)&&this.client.authStore.save(t.token,e),Object.assign({},t,{token:(t==null?void 0:t.token)||"",admin:e})}async authWithPassword(t,e,i,s){let n={method:"POST",body:{identity:t,password:e}};n=g("This form of authWithPassword(email, pass, body?, query?) is deprecated. Consider replacing it with authWithPassword(email, pass, options?).",n,i,s);const o=n.autoRefreshThreshold;delete n.autoRefreshThreshold,n.autoRefresh||R(this.client);let r=await this.client.send(this.baseCrudPath+"/auth-with-password",n);return r=this.authResponse(r),o&&function(l,u,d,x){R(l);const C=l.beforeSend,w=l.authStore.model,P=l.authStore.onChange((S,m)=>{(!S||(m==null?void 0:m.id)!=(w==null?void 0:w.id)||(m!=null&&m.collectionId||w!=null&&w.collectionId)&&(m==null?void 0:m.collectionId)!=(w==null?void 0:w.collectionId))&&R(l)});l._resetAutoRefresh=function(){P(),l.beforeSend=C,delete l._resetAutoRefresh},l.beforeSend=async(S,m)=>{var O;const $=l.authStore.token;if((O=m.query)!=null&&O.autoRefresh)return C?C(S,m):{url:S,sendOptions:m};let y=l.authStore.isValid;if(y&&_(l.authStore.token,u))try{await d()}catch{y=!1}y||await x();const E=m.headers||{};for(let v in E)if(v.toLowerCase()=="authorization"&&$==E[v]&&l.authStore.token){E[v]=l.authStore.token;break}return m.headers=E,C?C(S,m):{url:S,sendOptions:m}}}(this.client,o,()=>this.authRefresh({autoRefresh:!0}),()=>this.authWithPassword(t,e,Object.assign({autoRefresh:!0},n))),r}async authRefresh(t,e){let i={method:"POST"};return i=g("This form of authRefresh(body?, query?) is deprecated. Consider replacing it with authRefresh(options?).",i,t,e),this.client.send(this.baseCrudPath+"/auth-refresh",i).then(this.authResponse.bind(this))}async requestPasswordReset(t,e,i){let s={method:"POST",body:{email:t}};return s=g("This form of requestPasswordReset(email, body?, query?) is deprecated. Consider replacing it with requestPasswordReset(email, options?).",s,e,i),this.client.send(this.baseCrudPath+"/request-password-reset",s).then(()=>!0)}async confirmPasswordReset(t,e,i,s,n){let o={method:"POST",body:{token:t,password:e,passwordConfirm:i}};return o=g("This form of confirmPasswordReset(resetToken, password, passwordConfirm, body?, query?) is deprecated. Consider replacing it with confirmPasswordReset(resetToken, password, passwordConfirm, options?).",o,s,n),this.client.send(this.baseCrudPath+"/confirm-password-reset",o).then(()=>!0)}}const V=["requestKey","$cancelKey","$autoCancel","fetch","headers","body","query","params","cache","credentials","headers","integrity","keepalive","method","mode","redirect","referrer","referrerPolicy","signal","window"];function j(c){if(c){c.query=c.query||{};for(let t in c)V.includes(t)||(c.query[t]=c[t],delete c[t])}}class q extends T{constructor(){super(...arguments),this.clientId="",this.eventSource=null,this.subscriptions={},this.lastSentSubscriptions=[],this.maxConnectTimeout=15e3,this.reconnectAttempts=0,this.maxReconnectAttempts=1/0,this.predefinedReconnectIntervals=[200,300,500,1e3,1200,1500,2e3],this.pendingConnects=[]}get isConnected(){return!!this.eventSource&&!!this.clientId&&!this.pendingConnects.length}async subscribe(t,e,i){var o;if(!t)throw new Error("topic must be set.");let s=t;if(i){j(i=Object.assign({},i));const r="options="+encodeURIComponent(JSON.stringify({query:i.query,headers:i.headers}));s+=(s.includes("?")?"&":"?")+r}const n=function(r){const a=r;let l;try{l=JSON.parse(a==null?void 0:a.data)}catch{}e(l||{})};return this.subscriptions[s]||(this.subscriptions[s]=[]),this.subscriptions[s].push(n),this.isConnected?this.subscriptions[s].length===1?await this.submitSubscriptions():(o=this.eventSource)==null||o.addEventListener(s,n):await this.connect(),async()=>this.unsubscribeByTopicAndListener(t,n)}async unsubscribe(t){var i;let e=!1;if(t){const s=this.getSubscriptionsByTopic(t);for(let n in s)if(this.hasSubscriptionListeners(n)){for(let o of this.subscriptions[n])(i=this.eventSource)==null||i.removeEventListener(n,o);delete this.subscriptions[n],e||(e=!0)}}else this.subscriptions={};this.hasSubscriptionListeners()?e&&await this.submitSubscriptions():this.disconnect()}async unsubscribeByPrefix(t){var i;let e=!1;for(let s in this.subscriptions)if((s+"?").startsWith(t)){e=!0;for(let n of this.subscriptions[s])(i=this.eventSource)==null||i.removeEventListener(s,n);delete this.subscriptions[s]}e&&(this.hasSubscriptionListeners()?await this.submitSubscriptions():this.disconnect())}async unsubscribeByTopicAndListener(t,e){var n;let i=!1;const s=this.getSubscriptionsByTopic(t);for(let o in s){if(!Array.isArray(this.subscriptions[o])||!this.subscriptions[o].length)continue;let r=!1;for(let a=this.subscriptions[o].length-1;a>=0;a--)this.subscriptions[o][a]===e&&(r=!0,delete this.subscriptions[o][a],this.subscriptions[o].splice(a,1),(n=this.eventSource)==null||n.removeEventListener(o,e));r&&(this.subscriptions[o].length||delete this.subscriptions[o],i||this.hasSubscriptionListeners(o)||(i=!0))}this.hasSubscriptionListeners()?i&&await this.submitSubscriptions():this.disconnect()}hasSubscriptionListeners(t){var e,i;if(this.subscriptions=this.subscriptions||{},t)return!!((e=this.subscriptions[t])!=null&&e.length);for(let s in this.subscriptions)if((i=this.subscriptions[s])!=null&&i.length)return!0;return!1}async submitSubscriptions(){if(this.clientId)return this.addAllSubscriptionListeners(),this.lastSentSubscriptions=this.getNonEmptySubscriptionKeys(),this.client.send("/api/realtime",{method:"POST",body:{clientId:this.clientId,subscriptions:this.lastSentSubscriptions},requestKey:this.getSubscriptionsCancelKey()}).catch(t=>{if(!(t!=null&&t.isAbort))throw t})}getSubscriptionsCancelKey(){return"realtime_"+this.clientId}getSubscriptionsByTopic(t){const e={};t=t.includes("?")?t:t+"?";for(let i in this.subscriptions)(i+"?").startsWith(t)&&(e[i]=this.subscriptions[i]);return e}getNonEmptySubscriptionKeys(){const t=[];for(let e in this.subscriptions)this.subscriptions[e].length&&t.push(e);return t}addAllSubscriptionListeners(){if(this.eventSource){this.removeAllSubscriptionListeners();for(let t in this.subscriptions)for(let e of this.subscriptions[t])this.eventSource.addEventListener(t,e)}}removeAllSubscriptionListeners(){if(this.eventSource)for(let t in this.subscriptions)for(let e of this.subscriptions[t])this.eventSource.removeEventListener(t,e)}async connect(){if(!(this.reconnectAttempts>0))return new Promise((t,e)=>{this.pendingConnects.push({resolve:t,reject:e}),this.pendingConnects.length>1||this.initConnect()})}initConnect(){this.disconnect(!0),clearTimeout(this.connectTimeoutId),this.connectTimeoutId=setTimeout(()=>{this.connectErrorHandler(new Error("EventSource connect took too long."))},this.maxConnectTimeout),this.eventSource=new EventSource(this.client.buildUrl("/api/realtime")),this.eventSource.onerror=t=>{this.connectErrorHandler(new Error("Failed to establish realtime connection."))},this.eventSource.addEventListener("PB_CONNECT",t=>{const e=t;this.clientId=e==null?void 0:e.lastEventId,this.submitSubscriptions().then(async()=>{let i=3;for(;this.hasUnsentSubscriptions()&&i>0;)i--,await this.submitSubscriptions()}).then(()=>{for(let s of this.pendingConnects)s.resolve();this.pendingConnects=[],this.reconnectAttempts=0,clearTimeout(this.reconnectTimeoutId),clearTimeout(this.connectTimeoutId);const i=this.getSubscriptionsByTopic("PB_CONNECT");for(let s in i)for(let n of i[s])n(t)}).catch(i=>{this.clientId="",this.connectErrorHandler(i)})})}hasUnsentSubscriptions(){const t=this.getNonEmptySubscriptionKeys();if(t.length!=this.lastSentSubscriptions.length)return!0;for(const e of t)if(!this.lastSentSubscriptions.includes(e))return!0;return!1}connectErrorHandler(t){if(clearTimeout(this.connectTimeoutId),clearTimeout(this.reconnectTimeoutId),!this.clientId&&!this.reconnectAttempts||this.reconnectAttempts>this.maxReconnectAttempts){for(let i of this.pendingConnects)i.reject(new b(t));return this.pendingConnects=[],void this.disconnect()}this.disconnect(!0);const e=this.predefinedReconnectIntervals[this.reconnectAttempts]||this.predefinedReconnectIntervals[this.predefinedReconnectIntervals.length-1];this.reconnectAttempts++,this.reconnectTimeoutId=setTimeout(()=>{this.initConnect()},e)}disconnect(t=!1){var e;if(clearTimeout(this.connectTimeoutId),clearTimeout(this.reconnectTimeoutId),this.removeAllSubscriptionListeners(),this.client.cancelRequest(this.getSubscriptionsCancelKey()),(e=this.eventSource)==null||e.close(),this.eventSource=null,this.clientId="",!t){this.reconnectAttempts=0;for(let i of this.pendingConnects)i.resolve();this.pendingConnects=[]}}}class Z extends A{constructor(t,e){super(t),this.collectionIdOrName=e}get baseCrudPath(){return this.baseCollectionPath+"/records"}get baseCollectionPath(){return"/api/collections/"+encodeURIComponent(this.collectionIdOrName)}async subscribe(t,e,i){if(!t)throw new Error("Missing topic.");if(!e)throw new Error("Missing subscription callback.");return this.client.realtime.subscribe(this.collectionIdOrName+"/"+t,e,i)}async unsubscribe(t){return t?this.client.realtime.unsubscribe(this.collectionIdOrName+"/"+t):this.client.realtime.unsubscribeByPrefix(this.collectionIdOrName)}async getFullList(t,e){if(typeof t=="number")return super.getFullList(t,e);const i=Object.assign({},t,e);return super.getFullList(i)}async getList(t=1,e=30,i){return super.getList(t,e,i)}async getFirstListItem(t,e){return super.getFirstListItem(t,e)}async getOne(t,e){return super.getOne(t,e)}async create(t,e){return super.create(t,e)}async update(t,e,i){return super.update(t,e,i).then(s=>{var n,o,r;return((n=this.client.authStore.model)==null?void 0:n.id)!==(s==null?void 0:s.id)||((o=this.client.authStore.model)==null?void 0:o.collectionId)!==this.collectionIdOrName&&((r=this.client.authStore.model)==null?void 0:r.collectionName)!==this.collectionIdOrName||this.client.authStore.save(this.client.authStore.token,s),s})}async delete(t,e){return super.delete(t,e).then(i=>{var s,n,o;return!i||((s=this.client.authStore.model)==null?void 0:s.id)!==t||((n=this.client.authStore.model)==null?void 0:n.collectionId)!==this.collectionIdOrName&&((o=this.client.authStore.model)==null?void 0:o.collectionName)!==this.collectionIdOrName||this.client.authStore.clear(),i})}authResponse(t){const e=this.decode((t==null?void 0:t.record)||{});return this.client.authStore.save(t==null?void 0:t.token,e),Object.assign({},t,{token:(t==null?void 0:t.token)||"",record:e})}async listAuthMethods(t){return t=Object.assign({method:"GET"},t),this.client.send(this.baseCollectionPath+"/auth-methods",t).then(e=>Object.assign({},e,{usernamePassword:!!(e!=null&&e.usernamePassword),emailPassword:!!(e!=null&&e.emailPassword),authProviders:Array.isArray(e==null?void 0:e.authProviders)?e==null?void 0:e.authProviders:[]}))}async authWithPassword(t,e,i,s){let n={method:"POST",body:{identity:t,password:e}};return n=g("This form of authWithPassword(usernameOrEmail, pass, body?, query?) is deprecated. Consider replacing it with authWithPassword(usernameOrEmail, pass, options?).",n,i,s),this.client.send(this.baseCollectionPath+"/auth-with-password",n).then(o=>this.authResponse(o))}async authWithOAuth2Code(t,e,i,s,n,o,r){let a={method:"POST",body:{provider:t,code:e,codeVerifier:i,redirectUrl:s,createData:n}};return a=g("This form of authWithOAuth2Code(provider, code, codeVerifier, redirectUrl, createData?, body?, query?) is deprecated. Consider replacing it with authWithOAuth2Code(provider, code, codeVerifier, redirectUrl, createData?, options?).",a,o,r),this.client.send(this.baseCollectionPath+"/auth-with-oauth2",a).then(l=>this.authResponse(l))}authWithOAuth2(...t){if(t.length>1||typeof(t==null?void 0:t[0])=="string")return console.warn("PocketBase: This form of authWithOAuth2() is deprecated and may get removed in the future. Please replace with authWithOAuth2Code() OR use the authWithOAuth2() realtime form as shown in https://pocketbase.io/docs/authentication/#oauth2-integration."),this.authWithOAuth2Code((t==null?void 0:t[0])||"",(t==null?void 0:t[1])||"",(t==null?void 0:t[2])||"",(t==null?void 0:t[3])||"",(t==null?void 0:t[4])||{},(t==null?void 0:t[5])||{},(t==null?void 0:t[6])||{});const e=(t==null?void 0:t[0])||{};let i=null;e.urlCallback||(i=M(void 0));const s=new q(this.client);function n(){i==null||i.close(),s.unsubscribe()}const o={},r=e.requestKey;return r&&(o.requestKey=r),this.listAuthMethods(o).then(a=>{var x;const l=a.authProviders.find(C=>C.name===e.provider);if(!l)throw new b(new Error(`Missing or invalid provider "${e.provider}".`));const u=this.client.buildUrl("/api/oauth2-redirect"),d=r?(x=this.client.cancelControllers)==null?void 0:x[r]:void 0;return d&&(d.signal.onabort=()=>{n()}),new Promise(async(C,w)=>{var P;try{await s.subscribe("@oauth2",async y=>{var O;const E=s.clientId;try{if(!y.state||E!==y.state)throw new Error("State parameters don't match.");if(y.error||!y.code)throw new Error("OAuth2 redirect error or missing code: "+y.error);const v=Object.assign({},e);delete v.provider,delete v.scopes,delete v.createData,delete v.urlCallback,(O=d==null?void 0:d.signal)!=null&&O.onabort&&(d.signal.onabort=null);const z=await this.authWithOAuth2Code(l.name,y.code,l.codeVerifier,u,e.createData,v);C(z)}catch(v){w(new b(v))}n()});const S={state:s.clientId};(P=e.scopes)!=null&&P.length&&(S.scope=e.scopes.join(" "));const m=this._replaceQueryParams(l.authUrl+u,S);await(e.urlCallback||function(y){i?i.location.href=y:i=M(y)})(m)}catch(S){n(),w(new b(S))}})}).catch(a=>{throw n(),a})}async authRefresh(t,e){let i={method:"POST"};return i=g("This form of authRefresh(body?, query?) is deprecated. Consider replacing it with authRefresh(options?).",i,t,e),this.client.send(this.baseCollectionPath+"/auth-refresh",i).then(s=>this.authResponse(s))}async requestPasswordReset(t,e,i){let s={method:"POST",body:{email:t}};return s=g("This form of requestPasswordReset(email, body?, query?) is deprecated. Consider replacing it with requestPasswordReset(email, options?).",s,e,i),this.client.send(this.baseCollectionPath+"/request-password-reset",s).then(()=>!0)}async confirmPasswordReset(t,e,i,s,n){let o={method:"POST",body:{token:t,password:e,passwordConfirm:i}};return o=g("This form of confirmPasswordReset(token, password, passwordConfirm, body?, query?) is deprecated. Consider replacing it with confirmPasswordReset(token, password, passwordConfirm, options?).",o,s,n),this.client.send(this.baseCollectionPath+"/confirm-password-reset",o).then(()=>!0)}async requestVerification(t,e,i){let s={method:"POST",body:{email:t}};return s=g("This form of requestVerification(email, body?, query?) is deprecated. Consider replacing it with requestVerification(email, options?).",s,e,i),this.client.send(this.baseCollectionPath+"/request-verification",s).then(()=>!0)}async confirmVerification(t,e,i){let s={method:"POST",body:{token:t}};return s=g("This form of confirmVerification(token, body?, query?) is deprecated. Consider replacing it with confirmVerification(token, options?).",s,e,i),this.client.send(this.baseCollectionPath+"/confirm-verification",s).then(()=>{const n=I(t),o=this.client.authStore.model;return o&&!o.verified&&o.id===n.id&&o.collectionId===n.collectionId&&(o.verified=!0,this.client.authStore.save(this.client.authStore.token,o)),!0})}async requestEmailChange(t,e,i){let s={method:"POST",body:{newEmail:t}};return s=g("This form of requestEmailChange(newEmail, body?, query?) is deprecated. Consider replacing it with requestEmailChange(newEmail, options?).",s,e,i),this.client.send(this.baseCollectionPath+"/request-email-change",s).then(()=>!0)}async confirmEmailChange(t,e,i,s){let n={method:"POST",body:{token:t,password:e}};return n=g("This form of confirmEmailChange(token, password, body?, query?) is deprecated. Consider replacing it with confirmEmailChange(token, password, options?).",n,i,s),this.client.send(this.baseCollectionPath+"/confirm-email-change",n).then(()=>{const o=I(t),r=this.client.authStore.model;return r&&r.id===o.id&&r.collectionId===o.collectionId&&this.client.authStore.clear(),!0})}async listExternalAuths(t,e){return e=Object.assign({method:"GET"},e),this.client.send(this.baseCrudPath+"/"+encodeURIComponent(t)+"/external-auths",e)}async unlinkExternalAuth(t,e,i){return i=Object.assign({method:"DELETE"},i),this.client.send(this.baseCrudPath+"/"+encodeURIComponent(t)+"/external-auths/"+encodeURIComponent(e),i).then(()=>!0)}_replaceQueryParams(t,e={}){let i=t,s="";t.indexOf("?")>=0&&(i=t.substring(0,t.indexOf("?")),s=t.substring(t.indexOf("?")+1));const n={},o=s.split("&");for(const r of o){if(r=="")continue;const a=r.split("=");n[decodeURIComponent(a[0].replace(/\+/g," "))]=decodeURIComponent((a[1]||"").replace(/\+/g," "))}for(let r in e)e.hasOwnProperty(r)&&(e[r]==null?delete n[r]:n[r]=e[r]);s="";for(let r in n)n.hasOwnProperty(r)&&(s!=""&&(s+="&"),s+=encodeURIComponent(r.replace(/%20/g,"+"))+"="+encodeURIComponent(n[r].replace(/%20/g,"+")));return s!=""?i+"?"+s:i}}function M(c){if(typeof window>"u"||!(window!=null&&window.open))throw new b(new Error("Not in a browser context - please pass a custom urlCallback function."));let t=1024,e=768,i=window.innerWidth,s=window.innerHeight;t=t>i?i:t,e=e>s?s:e;let n=i/2-t/2,o=s/2-e/2;return window.open(c,"popup_window","width="+t+",height="+e+",top="+o+",left="+n+",resizable,menubar=no")}class Q extends A{get baseCrudPath(){return"/api/collections"}async import(t,e=!1,i){return i=Object.assign({method:"PUT",body:{collections:t,deleteMissing:e}},i),this.client.send(this.baseCrudPath+"/import",i).then(()=>!0)}}class tt extends T{async getList(t=1,e=30,i){return(i=Object.assign({method:"GET"},i)).query=Object.assign({page:t,perPage:e},i.query),this.client.send("/api/logs",i)}async getOne(t,e){if(!t)throw new b({url:this.client.buildUrl("/api/logs/"),status:404,response:{code:404,message:"Missing required log id.",data:{}}});return e=Object.assign({method:"GET"},e),this.client.send("/api/logs/"+encodeURIComponent(t),e)}async getStats(t){return t=Object.assign({method:"GET"},t),this.client.send("/api/logs/stats",t)}}class et extends T{async check(t){return t=Object.assign({method:"GET"},t),this.client.send("/api/health",t)}}class st extends T{getUrl(t,e,i={}){if(!e||!(t!=null&&t.id)||!(t!=null&&t.collectionId)&&!(t!=null&&t.collectionName))return"";const s=[];s.push("api"),s.push("files"),s.push(encodeURIComponent(t.collectionId||t.collectionName)),s.push(encodeURIComponent(t.id)),s.push(encodeURIComponent(e));let n=this.client.buildUrl(s.join("/"));if(Object.keys(i).length){i.download===!1&&delete i.download;const o=new URLSearchParams(i);n+=(n.includes("?")?"&":"?")+o}return n}async getToken(t){return t=Object.assign({method:"POST"},t),this.client.send("/api/files/token",t).then(e=>(e==null?void 0:e.token)||"")}}class it extends T{async getFullList(t){return t=Object.assign({method:"GET"},t),this.client.send("/api/backups",t)}async create(t,e){return e=Object.assign({method:"POST",body:{name:t}},e),this.client.send("/api/backups",e).then(()=>!0)}async upload(t,e){return e=Object.assign({method:"POST",body:t},e),this.client.send("/api/backups/upload",e).then(()=>!0)}async delete(t,e){return e=Object.assign({method:"DELETE"},e),this.client.send(`/api/backups/${encodeURIComponent(t)}`,e).then(()=>!0)}async restore(t,e){return e=Object.assign({method:"POST"},e),this.client.send(`/api/backups/${encodeURIComponent(t)}/restore`,e).then(()=>!0)}getDownloadUrl(t,e){return this.client.buildUrl(`/api/backups/${encodeURIComponent(e)}?token=${encodeURIComponent(t)}`)}}class nt{constructor(t="/",e,i="en-US"){this.cancelControllers={},this.recordServices={},this.enableAutoCancellation=!0,this.baseUrl=t,this.lang=i,this.authStore=e||new X,this.admins=new J(this),this.collections=new Q(this),this.files=new st(this),this.logs=new tt(this),this.settings=new H(this),this.realtime=new q(this),this.health=new et(this),this.backups=new it(this)}collection(t){return this.recordServices[t]||(this.recordServices[t]=new Z(this,t)),this.recordServices[t]}autoCancellation(t){return this.enableAutoCancellation=!!t,this}cancelRequest(t){return this.cancelControllers[t]&&(this.cancelControllers[t].abort(),delete this.cancelControllers[t]),this}cancelAllRequests(){for(let t in this.cancelControllers)this.cancelControllers[t].abort();return this.cancelControllers={},this}filter(t,e){if(!e)return t;for(let i in e){let s=e[i];switch(typeof s){case"boolean":case"number":s=""+s;break;case"string":s="'"+s.replace(/'/g,"\\'")+"'";break;default:s=s===null?"null":s instanceof Date?"'"+s.toISOString().replace("T"," ")+"'":"'"+JSON.stringify(s).replace(/'/g,"\\'")+"'"}t=t.replaceAll("{:"+i+"}",s)}return t}getFileUrl(t,e,i={}){return this.files.getUrl(t,e,i)}buildUrl(t){var i;let e=this.baseUrl;return typeof window>"u"||!window.location||e.startsWith("https://")||e.startsWith("http://")||(e=(i=window.location.origin)!=null&&i.endsWith("/")?window.location.origin.substring(0,window.location.origin.length-1):window.location.origin||"",this.baseUrl.startsWith("/")||(e+=window.location.pathname||"/",e+=e.endsWith("/")?"":"/"),e+=this.baseUrl),t&&(e+=e.endsWith("/")?"":"/",e+=t.startsWith("/")?t.substring(1):t),e}async send(t,e){e=this.initSendOptions(t,e);let i=this.buildUrl(t);if(this.beforeSend){const s=Object.assign({},await this.beforeSend(i,e));s.url!==void 0||s.options!==void 0?(i=s.url||i,e=s.options||e):Object.keys(s).length&&(e=s,console!=null&&console.warn&&console.warn("Deprecated format of beforeSend return: please use `return { url, options }`, instead of `return options`."))}if(e.query!==void 0){const s=this.serializeQueryParams(e.query);s&&(i+=(i.includes("?")?"&":"?")+s),delete e.query}return this.getHeader(e.headers,"Content-Type")=="application/json"&&e.body&&typeof e.body!="string"&&(e.body=JSON.stringify(e.body)),(e.fetch||fetch)(i,e).then(async s=>{let n={};try{n=await s.json()}catch{}if(this.afterSend&&(n=await this.afterSend(s,n)),s.status>=400)throw new b({url:s.url,status:s.status,data:n});return n}).catch(s=>{throw new b(s)})}initSendOptions(t,e){if((e=Object.assign({method:"GET"},e)).body=this.convertToFormDataIfNeeded(e.body),j(e),e.query=Object.assign({},e.params,e.query),e.requestKey===void 0&&(e.$autoCancel===!1||e.query.$autoCancel===!1?e.requestKey=null:(e.$cancelKey||e.query.$cancelKey)&&(e.requestKey=e.$cancelKey||e.query.$cancelKey)),delete e.$autoCancel,delete e.query.$autoCancel,delete e.$cancelKey,delete e.query.$cancelKey,this.getHeader(e.headers,"Content-Type")!==null||this.isFormData(e.body)||(e.headers=Object.assign({},e.headers,{"Content-Type":"application/json"})),this.getHeader(e.headers,"Accept-Language")===null&&(e.headers=Object.assign({},e.headers,{"Accept-Language":this.lang})),this.authStore.token&&this.getHeader(e.headers,"Authorization")===null&&(e.headers=Object.assign({},e.headers,{Authorization:this.authStore.token})),this.enableAutoCancellation&&e.requestKey!==null){const i=e.requestKey||(e.method||"GET")+t;delete e.requestKey,this.cancelRequest(i);const s=new AbortController;this.cancelControllers[i]=s,e.signal=s.signal}return e}convertToFormDataIfNeeded(t){if(typeof FormData>"u"||t===void 0||typeof t!="object"||t===null||this.isFormData(t)||!this.hasBlobField(t))return t;const e=new FormData;for(const i in t){const s=t[i];if(typeof s!="object"||this.hasBlobField({data:s})){const n=Array.isArray(s)?s:[s];for(let o of n)e.append(i,o)}else{let n={};n[i]=s,e.append("@jsonPayload",JSON.stringify(n))}}return e}hasBlobField(t){for(const e in t){const i=Array.isArray(t[e])?t[e]:[t[e]];for(const s of i)if(typeof Blob<"u"&&s instanceof Blob||typeof File<"u"&&s instanceof File)return!0}return!1}getHeader(t,e){t=t||{},e=e.toLowerCase();for(let i in t)if(i.toLowerCase()==e)return t[i];return null}isFormData(t){return t&&(t.constructor.name==="FormData"||typeof FormData<"u"&&t instanceof FormData)}serializeQueryParams(t){const e=[];for(const i in t){if(t[i]===null)continue;const s=t[i],n=encodeURIComponent(i);if(Array.isArray(s))for(const o of s)e.push(n+"="+encodeURIComponent(o));else s instanceof Date?e.push(n+"="+encodeURIComponent(s.toISOString())):typeof s!==null&&typeof s=="object"?e.push(n+"="+encodeURIComponent(JSON.stringify(s))):e.push(n+"="+encodeURIComponent(s))}return e.join("&")}}const N="http://localhost:8090",h=new nt(N);class ot{constructor(){this.callbacks=[],this.user=null,this.checkAuthStatus(),h.authStore.onChange(()=>{this.checkAuthStatus(),this.notifyCallbacks()})}checkAuthStatus(){this.user=h.authStore.isValid?h.authStore.model:null}subscribe(t){this.callbacks.push(t),t(this.user)}unsubscribe(t){this.callbacks=this.callbacks.filter(e=>e!==t)}notifyCallbacks(){this.callbacks.forEach(t=>t(this.user))}async loginWithDiscord(){try{return await h.collection("users").authWithOAuth2({provider:"discord"})}catch(t){throw console.error("Discord login failed:",t),t}}logout(){h.authStore.clear()}isLoggedIn(){return h.authStore.isValid}getUser(){return this.user}}const f=new ot;class rt{constructor(){this.ws=null,this.callbacks={systems:[],fleets:[],trades:[],tick:[]}}subscribe(t,e){this.callbacks[t]&&this.callbacks[t].push(e)}unsubscribe(t,e){this.callbacks[t]&&(this.callbacks[t]=this.callbacks[t].filter(i=>i!==e))}notifyCallbacks(t,e){this.callbacks[t]&&this.callbacks[t].forEach(i=>i(e))}connectWebSocket(){try{this.ws=new WebSocket(`${N.replace("http","ws")}/api/stream`),this.ws.onopen=()=>{console.log("WebSocket connected"),this.updateConnectionStatus("connected"),h.authStore.isValid&&setTimeout(()=>{this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({type:"auth",token:h.authStore.token}))},100)},this.ws.onmessage=t=>{try{const e=JSON.parse(t.data);this.handleWebSocketMessage(e)}catch(e){console.error("Failed to parse WebSocket message:",e)}},this.ws.onclose=()=>{console.log("WebSocket disconnected"),this.updateConnectionStatus("disconnected"),setTimeout(()=>this.connectWebSocket(),5e3)},this.ws.onerror=t=>{console.error("WebSocket error:",t),this.updateConnectionStatus("error")}}catch(t){console.error("Failed to connect WebSocket:",t),this.updateConnectionStatus("error")}}updateConnectionStatus(t){const e=document.getElementById("ws-status");e&&(e.textContent=t==="connected"?"ðŸŸ¢":t==="error"?"ðŸ”´":"ðŸŸ¡",e.title=`WebSocket: ${t}`)}handleWebSocketMessage(t){switch(t.type){case"tick":this.notifyCallbacks("tick",t.payload);break;case"system_update":this.notifyCallbacks("systems",t.payload);break;case"fleet_update":this.notifyCallbacks("fleets",t.payload);break;case"trade_update":this.notifyCallbacks("trades",t.payload);break;default:console.log("Unknown WebSocket message type:",t.type)}}async getSystems(){try{return await h.collection("systems").getFullList({sort:"x,y"})}catch(t){return console.error("Failed to fetch systems:",t),[]}}async getSystem(t){try{return await h.collection("systems").getOne(t)}catch(e){return console.error("Failed to fetch system:",e),null}}async getFleets(t=null){try{const e=t?`owner_id = "${t}"`:"";return await h.collection("fleets").getFullList({filter:e,sort:"eta"})}catch(e){return console.error("Failed to fetch fleets:",e),[]}}async getTrades(t=null){try{const e=t?`owner_id = "${t}"`:"";return await h.collection("trade_routes").getFullList({filter:e,sort:"eta"})}catch(e){return console.error("Failed to fetch trades:",e),[]}}async getTreaties(t=null){try{const e=t?`a_id = "${t}" || b_id = "${t}"`:"";return await h.collection("treaties").getFullList({filter:e,sort:"-created_at"})}catch(e){return console.error("Failed to fetch treaties:",e),[]}}async getBanks(t=null){try{const e=t?`owner_id = "${t}"`:"";return await h.collection("banks").getFullList({filter:e,sort:"-created_at"})}catch(e){return console.error("Failed to fetch banks:",e),[]}}async sendFleet(t,e,i){if(!h.authStore.isValid)throw new Error("Not authenticated");try{return await h.send("/api/orders/fleet",{method:"POST",body:JSON.stringify({from_id:t,to_id:e,strength:i}),headers:{"Content-Type":"application/json"}})}catch(s){throw console.error("Failed to send fleet:",s),s}}async queueBuilding(t,e){if(!h.authStore.isValid)throw new Error("Not authenticated");try{return await h.send("/api/orders/build",{method:"POST",body:JSON.stringify({system_id:t,building_type:e}),headers:{"Content-Type":"application/json"}})}catch(i){throw console.error("Failed to queue building:",i),i}}async createTradeRoute(t,e,i,s){if(!h.authStore.isValid)throw new Error("Not authenticated");try{return await h.send("/api/orders/trade",{method:"POST",body:JSON.stringify({from_id:t,to_id:e,cargo:i,capacity:s}),headers:{"Content-Type":"application/json"}})}catch(n){throw console.error("Failed to create trade route:",n),n}}async proposeTreaty(t,e,i){if(!h.authStore.isValid)throw new Error("Not authenticated");try{return await h.send("/diplomacy",{method:"POST",body:JSON.stringify({player_id:t,type:e,terms:i}),headers:{"Content-Type":"application/json"}})}catch(s){throw console.error("Failed to propose treaty:",s),s}}async getMap(){var t;try{return await h.send("/api/map",{method:"GET"})}catch(e){return(t=e.message)!=null&&t.includes("autocancelled")||console.error("Failed to fetch map:",e),null}}async getStatus(){try{return await h.send("/api/status",{method:"GET"})}catch(t){return console.error("Failed to fetch status:",t),null}}}const p=new rt;f.subscribe(c=>{p.ws||p.connectWebSocket()});p.connectWebSocket();class at{constructor(){this.systems=[],this.fleets=[],this.trades=[],this.treaties=[],this.banks=[],this.mapData=null,this.selectedSystem=null,this.currentTick=1,this.ticksPerMinute=6,this.playerResources={credits:0,food:0,ore:0,goods:0,fuel:0},this.callbacks=[],this.initialized=!1,f.subscribe(t=>{t&&!this.initialized?this.initialize():t||this.reset()}),this.loadMapData(),p.subscribe("systems",t=>this.updateSystems(t)),p.subscribe("fleets",t=>this.updateFleets(t)),p.subscribe("trades",t=>this.updateTrades(t)),p.subscribe("tick",t=>this.handleTick(t))}async initialize(){var t,e,i,s;if(!this.initialized)try{const[n,o,r,a,l,u]=await Promise.all([p.getFleets((t=f.getUser())==null?void 0:t.id),p.getTrades((e=f.getUser())==null?void 0:e.id),p.getTreaties((i=f.getUser())==null?void 0:i.id),p.getBanks((s=f.getUser())==null?void 0:s.id),p.getMap(),p.getStatus()]);l&&l.systems&&(this.systems=l.systems,this.mapData=l),this.fleets=n,this.trades=o,this.treaties=r,this.banks=a,u&&(this.currentTick=u.current_tick||1,this.ticksPerMinute=u.ticks_per_minute||6),this.updatePlayerResources(),this.initialized=!0,this.notifyCallbacks()}catch(n){console.error("Failed to initialize game state:",n)}}reset(){this.systems=[],this.fleets=[],this.trades=[],this.treaties=[],this.banks=[],this.mapData=null,this.selectedSystem=null,this.currentTick=1,this.ticksPerMinute=6,this.playerResources={credits:0,food:0,ore:0,goods:0,fuel:0},this.initialized=!1,this.notifyCallbacks()}async loadMapData(){try{console.log("GameState: Loading map data...");const t=await p.getMap();console.log("GameState: Received map data",t),t&&t.systems&&(console.log("GameState: Setting systems",t.systems.length,"systems"),this.systems=t.systems,this.mapData=t,this.notifyCallbacks())}catch(t){console.error("Failed to load map data:",t)}}subscribe(t){this.callbacks.push(t),t(this)}unsubscribe(t){this.callbacks=this.callbacks.filter(e=>e!==t)}notifyCallbacks(){this.callbacks.forEach(t=>t(this))}updateSystems(t){if(Array.isArray(t))this.systems=t;else{const e=this.systems.findIndex(i=>i.id===t.id);e>=0?this.systems[e]=t:this.systems.push(t)}this.updatePlayerResources(),this.notifyCallbacks()}updateFleets(t){if(Array.isArray(t))this.fleets=t;else{const e=this.fleets.findIndex(i=>i.id===t.id);e>=0?this.fleets[e]=t:this.fleets.push(t)}this.notifyCallbacks()}updateTrades(t){if(Array.isArray(t))this.trades=t;else{const e=this.trades.findIndex(i=>i.id===t.id);e>=0?this.trades[e]=t:this.trades.push(t)}this.notifyCallbacks()}handleTick(t){this.currentTick=t.tick||this.currentTick+1,console.log("Tick update received:",t,"Current tick:",this.currentTick),this.notifyCallbacks(),this.currentTick%6===0&&this.initialize()}updatePlayerResources(){const t=f.getUser();if(!t)return;const e=t.credits||0,s=this.getPlayerBanks().filter(o=>o.active!==!1).length,n=this.systems.filter(o=>o.owner_id===t.id);this.playerResources=n.reduce((o,r)=>({credits:o.credits+(r.credits||0),food:o.food+(r.food||0),ore:o.ore+(r.ore||0),goods:o.goods+(r.goods||0),fuel:o.fuel+(r.fuel||0)}),{credits:e,food:0,ore:0,goods:0,fuel:0}),this.creditIncome=s}selectSystem(t){this.selectedSystem=this.systems.find(e=>e.id===t)||null,this.notifyCallbacks()}getSelectedSystem(){return this.selectedSystem}getOwnedSystems(){const t=f.getUser();return t?this.systems.filter(e=>e.owner_id===t.id):[]}getPlayerFleets(){const t=f.getUser();return t?this.fleets.filter(e=>e.owner_id===t.id):[]}getPlayerTrades(){const t=f.getUser();return t?this.trades.filter(e=>e.owner_id===t.id):[]}async sendFleet(t,e,i){return await p.sendFleet(t,e,i)}async queueBuilding(t,e){return await p.queueBuilding(t,e)}async createTradeRoute(t,e,i,s){return await p.createTradeRoute(t,e,i,s)}async proposeTreaty(t,e,i){return await p.proposeTreaty(t,e,i)}getPlayerBanks(){var e;const t=f.getUser();return t?((e=this.banks)==null?void 0:e.filter(i=>i.owner_id===t.id))||[]:[]}}const k=new at;class ct{constructor(t){this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.systems=[],this.lanes=[],this.fleets=[],this.selectedSystem=null,this.viewX=0,this.viewY=0,this.zoom=1,this.maxZoom=3,this.minZoom=.3,this.colors={background:"#000508",star:"#4080ff",starOwned:"#f1a9ff",starEnemy:"#ff6b6b",starNeutral:"#8cb3ff",lane:"rgba(64, 128, 255, 0.2)",laneActive:"rgba(241, 169, 255, 0.6)",fleet:"#8b5cf6",selection:"#f1a9ff",grid:"rgba(255, 255, 255, 0.02)",nebula:"rgba(139, 92, 246, 0.1)",starGlow:"rgba(64, 128, 255, 0.3)"},this.animationFrame=null,this.lastTime=0,this.setupCanvas(),this.setupEventListeners(),this.startRenderLoop()}setupCanvas(){this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas())}resizeCanvas(){const t=this.canvas.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height}setupEventListeners(){let t=!1,e=0,i=0;this.canvas.addEventListener("mousedown",s=>{if(s.button===0){const n=this.screenToWorld(s.offsetX,s.offsetY),o=this.getSystemAt(n.x,n.y);o?this.selectSystem(o):(t=!0,e=s.offsetX,i=s.offsetY,this.canvas.style.cursor="grabbing")}}),this.canvas.addEventListener("mousemove",s=>{if(t){const n=s.offsetX-e,o=s.offsetY-i;this.viewX+=n/this.zoom,this.viewY+=o/this.zoom,e=s.offsetX,i=s.offsetY}else{const n=this.screenToWorld(s.offsetX,s.offsetY),o=this.getSystemAt(n.x,n.y);this.showTooltip(o,s.offsetX,s.offsetY)}}),this.canvas.addEventListener("mouseup",s=>{s.button===0&&(t=!1,this.canvas.style.cursor="crosshair")}),this.canvas.addEventListener("contextmenu",s=>{s.preventDefault();const n=this.screenToWorld(s.offsetX,s.offsetY),o=this.getSystemAt(n.x,n.y);o&&this.showContextMenu(o,s.offsetX,s.offsetY)}),this.canvas.addEventListener("wheel",s=>{s.preventDefault();const n=s.deltaY>0?.9:1.1,o=Math.max(this.minZoom,Math.min(this.maxZoom,this.zoom*n));if(o!==this.zoom){const r=this.canvas.getBoundingClientRect(),a=s.clientX-r.left,l=s.clientY-r.top,u=this.screenToWorld(a,l);this.zoom=o;const d=this.screenToWorld(a,l);this.viewX+=u.x-d.x,this.viewY+=u.y-d.y}})}screenToWorld(t,e){return{x:(t-this.canvas.width/2)/this.zoom-this.viewX,y:(e-this.canvas.height/2)/this.zoom-this.viewY}}worldToScreen(t,e){return{x:(t+this.viewX)*this.zoom+this.canvas.width/2,y:(e+this.viewY)*this.zoom+this.canvas.height/2}}getSystemAt(t,e){return this.systems.find(s=>{const n=s.x-t,o=s.y-e;return Math.sqrt(n*n+o*o)<=20})}selectSystem(t){this.selectedSystem=t,this.canvas.dispatchEvent(new CustomEvent("systemSelected",{detail:{system:t}}))}showTooltip(t,e,i){const s=document.getElementById("tooltip");t?(s.innerHTML=`
        <div class="font-semibold">${t.name||`System ${t.id}`}</div>
        <div class="text-xs">
          <div>Position: ${t.x}, ${t.y}</div>
          <div>Population: ${t.pop||0}</div>
          <div>Owner: ${t.owner_name||"Uncolonized"}</div>
        </div>
      `,s.style.left=`${e+10}px`,s.style.top=`${i-10}px`,s.classList.remove("hidden")):s.classList.add("hidden")}showContextMenu(t,e,i){const s=document.getElementById("context-menu");s.style.left=`${e}px`,s.style.top=`${i}px`,s.classList.remove("hidden"),s.dataset.systemId=t.id;const n=o=>{s.contains(o.target)||(s.classList.add("hidden"),document.removeEventListener("click",n))};setTimeout(()=>document.addEventListener("click",n),0)}startRenderLoop(){const t=e=>{const i=e-this.lastTime;this.lastTime=e,this.clear(),this.drawBackground(),this.drawLanes(),this.drawSystems(),this.drawFleets(i),this.drawUI(),this.animationFrame=requestAnimationFrame(t)};this.animationFrame=requestAnimationFrame(t)}clear(){this.ctx.fillStyle=this.colors.background,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}drawBackground(){this.ctx.globalAlpha=.1;const t=Date.now()*1e-4;for(let r=0;r<3;r++){const a=r*150,l=Math.sin(t+r)*200+a,u=Math.cos(t*.7+r)*150+a,d=300+Math.sin(t*.5+r)*50,x=this.ctx.createRadialGradient(l,u,0,l,u,d);x.addColorStop(0,this.colors.nebula),x.addColorStop(.5,"rgba(64, 128, 255, 0.05)"),x.addColorStop(1,"rgba(0, 0, 0, 0)"),this.ctx.fillStyle=x,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}this.ctx.globalAlpha=1,this.ctx.strokeStyle=this.colors.grid,this.ctx.lineWidth=1,this.ctx.globalAlpha=.15;const e=100,i=Math.floor((-this.viewX-this.canvas.width/2/this.zoom)/e)*e,s=Math.ceil((-this.viewX+this.canvas.width/2/this.zoom)/e)*e,n=Math.floor((-this.viewY-this.canvas.height/2/this.zoom)/e)*e,o=Math.ceil((-this.viewY+this.canvas.height/2/this.zoom)/e)*e;this.ctx.beginPath();for(let r=i;r<=s;r+=e){const a=this.worldToScreen(r,0);this.ctx.moveTo(a.x,0),this.ctx.lineTo(a.x,this.canvas.height)}for(let r=n;r<=o;r+=e){const a=this.worldToScreen(0,r);this.ctx.moveTo(0,a.y),this.ctx.lineTo(this.canvas.width,a.y)}this.ctx.stroke(),this.ctx.globalAlpha=1}drawLanes(){this.ctx.strokeStyle=this.colors.lane,this.ctx.lineWidth=2,this.ctx.globalAlpha=.6,this.lanes.forEach(t=>{const e=this.worldToScreen(t.fromX,t.fromY),i=this.worldToScreen(t.toX,t.toY);this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(i.x,i.y),this.ctx.stroke()}),this.ctx.globalAlpha=1}drawSystems(){this.systems.forEach(t=>{const e=this.worldToScreen(t.x,t.y);if(e.x<-50||e.x>this.canvas.width+50||e.y<-50||e.y>this.canvas.height+50)return;let i=this.colors.star;t.owner_id&&(i=this.colors.starOwned);const s=6*this.zoom,n=20*this.zoom,o=this.ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,n);o.addColorStop(0,i+"40"),o.addColorStop(.3,i+"20"),o.addColorStop(1,i+"00"),this.ctx.fillStyle=o,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,n,0,Math.PI*2),this.ctx.fill();const r=this.ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,s);if(r.addColorStop(0,"#ffffff"),r.addColorStop(.7,i),r.addColorStop(1,i+"cc"),this.ctx.fillStyle=r,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,s,0,Math.PI*2),this.ctx.fill(),t.owner_id&&this.zoom>.6&&(this.ctx.strokeStyle=this.colors.starOwned,this.ctx.lineWidth=1,this.ctx.globalAlpha=.8,this.ctx.beginPath(),this.ctx.moveTo(e.x-s*1.5,e.y),this.ctx.lineTo(e.x+s*1.5,e.y),this.ctx.moveTo(e.x,e.y-s*1.5),this.ctx.lineTo(e.x,e.y+s*1.5),this.ctx.stroke(),this.ctx.globalAlpha=1),this.selectedSystem&&this.selectedSystem.id===t.id){const a=Date.now()*.005,l=(12+Math.sin(a)*2)*this.zoom;this.ctx.strokeStyle=this.colors.selection,this.ctx.lineWidth=2,this.ctx.globalAlpha=.8+Math.sin(a)*.2,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,l,0,Math.PI*2),this.ctx.stroke(),this.ctx.globalAlpha=1}if(this.zoom>.8){const a=Math.floor(11*this.zoom);this.ctx.font=`${a}px monospace`,this.ctx.textAlign="center",this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.fillText(t.name||`S${t.id.slice(-3)}`,e.x+1,e.y-15*this.zoom+1),this.ctx.fillStyle="rgba(255, 255, 255, 0.95)",this.ctx.fillText(t.name||`S${t.id.slice(-3)}`,e.x,e.y-15*this.zoom)}if(t.pop>0&&this.zoom>.5){const a=Math.floor(9*this.zoom);this.ctx.font=`${a}px monospace`,this.ctx.textAlign="center",this.ctx.fillStyle="rgba(241, 169, 255, 0.2)",this.ctx.fillRect(e.x-8*this.zoom,e.y+12*this.zoom,16*this.zoom,12*this.zoom),this.ctx.fillStyle="#f1a9ff",this.ctx.fillText(t.pop.toString(),e.x,e.y+21*this.zoom)}})}drawFleets(t){this.fleets.forEach(e=>{const i=this.systems.find(l=>l.id===e.from_id),s=this.systems.find(l=>l.id===e.to_id);if(!i||!s)return;const n=.5,o=i.x+(s.x-i.x)*n,r=i.y+(s.y-i.y)*n,a=this.worldToScreen(o,r);this.ctx.fillStyle=this.colors.fleet,this.ctx.beginPath(),this.ctx.arc(a.x,a.y,4*this.zoom,0,Math.PI*2),this.ctx.fill(),this.zoom>.7&&(this.ctx.fillStyle="#ffffff",this.ctx.font=`${Math.floor(8*this.zoom)}px monospace`,this.ctx.textAlign="center",this.ctx.fillText(e.strength.toString(),a.x,a.y-8*this.zoom))})}drawUI(){this.ctx.fillStyle="#ffffff",this.ctx.font="12px monospace",this.ctx.textAlign="left",this.ctx.fillText(`Zoom: ${(this.zoom*100).toFixed(0)}%`,10,25);const t=this.screenToWorld(this.canvas.width/2,this.canvas.height/2);this.ctx.fillText(`Center: ${t.x.toFixed(0)}, ${t.y.toFixed(0)}`,10,45)}setSystems(t){console.log("MapRenderer: Setting systems",t.length,"systems"),this.systems=t}setLanes(t){this.lanes=t}setFleets(t){this.fleets=t}setSelectedSystem(t){this.selectedSystem=t}centerOnSystem(t){const e=this.systems.find(i=>i.id===t);e&&(this.viewX=-e.x,this.viewY=-e.y)}fitToSystems(){if(this.systems.length===0)return;const t=Math.min(...this.systems.map(d=>d.x)),e=Math.max(...this.systems.map(d=>d.x)),i=Math.min(...this.systems.map(d=>d.y)),s=Math.max(...this.systems.map(d=>d.y)),n=(t+e)/2,o=(i+s)/2;this.viewX=-n,this.viewY=-o;const r=e-t+100,a=s-i+100,l=this.canvas.width/r,u=this.canvas.height/a;this.zoom=Math.min(l,u,this.maxZoom)}destroy(){this.animationFrame&&cancelAnimationFrame(this.animationFrame)}}class lt{constructor(){this.currentUser=null,this.gameState=null,this.tickTimer=null}updateAuthUI(t){this.currentUser=t;const e=document.getElementById("login-btn"),i=document.getElementById("user-info"),s=document.getElementById("username");t?(e.classList.add("hidden"),i.classList.remove("hidden"),s.textContent=t.username):(e.classList.remove("hidden"),i.classList.add("hidden"),s.textContent="")}updateGameUI(t){this.gameState=t,this.updateResourcesUI(t.playerResources),this.updateSystemInfoUI(t.selectedSystem),this.updateGameStatusUI(t)}updateResourcesUI(t){var i;document.getElementById("credits").textContent=t.credits.toLocaleString(),document.getElementById("food").textContent=t.food.toLocaleString(),document.getElementById("ore").textContent=t.ore.toLocaleString(),document.getElementById("goods").textContent=t.goods.toLocaleString(),document.getElementById("fuel").textContent=t.fuel.toLocaleString();const e=document.getElementById("credit-income");((i=this.gameState)==null?void 0:i.creditIncome)>0?(e.textContent=`(+${this.gameState.creditIncome}/tick)`,e.style.display="inline"):e.style.display="none"}updateSystemInfoUI(t){const e=document.getElementById("selected-system");if(t){const i=this.currentUser&&t.owner_id===this.currentUser.id;e.innerHTML=`
        <div class="space-y-2">
          <div class="font-semibold text-orange-300">${t.name||`System ${t.id.slice(-3)}`}</div>
          <div class="text-xs space-y-1">
            <div>Position: ${t.x}, ${t.y}</div>
            <div>Population: ${t.pop||0}</div>
            <div>Morale: ${t.morale||0}%</div>
            <div>Owner: ${t.owner_name||"Uncolonized"}</div>
          </div>
          ${i?`
            <div class="text-xs space-y-1 pt-2 border-t border-space-600">
              <div class="font-medium">Resources:</div>
              <div>Food: ${t.food||0}</div>
              <div>Ore: ${t.ore||0}</div>
              <div>Goods: ${t.goods||0}</div>
              <div>Fuel: ${t.fuel||0}</div>
            </div>
            <div class="text-xs space-y-1 pt-2 border-t border-space-600">
              <div class="font-medium">Buildings:</div>
              <div>Habitat: Lvl ${t.hab_lvl||0}</div>
              <div>Farm: Lvl ${t.farm_lvl||0}</div>
              <div>Mine: Lvl ${t.mine_lvl||0}</div>
              <div>Factory: Lvl ${t.fac_lvl||0}</div>
              <div>Shipyard: Lvl ${t.yard_lvl||0}</div>
            </div>
          `:""}
        </div>
      `}else e.innerHTML="Click a system to view details"}updateGameStatusUI(t){const e=document.getElementById("current-turn"),i=e.textContent,s=`Tick ${t.currentTick}`;e.textContent=s,i!==s&&(e.style.animation="none",e.offsetHeight,e.style.animation="flash 0.5s ease-out"),document.getElementById("player-count").textContent=t.systems.filter(r=>r.owner_id).length;const n=t.ticksPerMinute||6,o=Math.round(60/n);document.getElementById("next-tick").textContent=`${n}/min (${o}s)`}startTickTimer(t){this.tickTimer&&clearInterval(this.tickTimer);const e=()=>{const s=t-new Date;if(s<=0){document.getElementById("next-tick").textContent="Processing...",clearInterval(this.tickTimer);return}const n=Math.floor(s/6e4),o=Math.floor(s%6e4/1e3);document.getElementById("next-tick").textContent=`${n}:${o.toString().padStart(2,"0")}`};e(),this.tickTimer=setInterval(e,1e3)}showModal(t,e){const i=document.getElementById("modal-overlay"),s=document.getElementById("modal-content");s.innerHTML=`
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">${t}</h2>
        <button id="modal-close" class="text-space-400 hover:text-space-200">&times;</button>
      </div>
      ${e}
    `,i.classList.remove("hidden"),document.getElementById("modal-close").addEventListener("click",()=>{this.hideModal()})}hideModal(){document.getElementById("modal-overlay").classList.add("hidden")}showError(t){this.showModal("Error",`
      <div class="text-red-400 mb-4">${t}</div>
      <button class="w-full px-4 py-2 bg-space-700 hover:bg-space-600 rounded" onclick="document.getElementById('modal-overlay').classList.add('hidden')">
        OK
      </button>
    `)}showBuildModal(t){const i=[{type:"habitat",name:"Habitat",cost:100,description:"Increases population capacity"},{type:"farm",name:"Farm",cost:150,description:"Produces food"},{type:"mine",name:"Mine",cost:200,description:"Produces ore"},{type:"factory",name:"Factory",cost:300,description:"Produces goods"},{type:"shipyard",name:"Shipyard",cost:500,description:"Enables fleet construction"},{type:"bank",name:"Crypto Server",cost:1e3,description:"Generates 1 credit per tick"}].map(s=>`
      <button class="w-full p-3 bg-space-700 hover:bg-space-600 rounded mb-2 text-left"
              onclick="window.gameState.queueBuilding('${t.id}', '${s.type}')">
        <div class="font-semibold">${s.name}</div>
        <div class="text-sm text-space-300">${s.description}</div>
        <div class="text-sm text-green-400">Cost: ${s.cost} credits</div>
      </button>
    `).join("");this.showModal(`Build in ${t.name||`System ${t.id.slice(-3)}`}`,`
      <div class="space-y-2">
        ${i}
      </div>
    `)}showSendFleetModal(t){var s;const e=((s=this.gameState)==null?void 0:s.getOwnedSystems())||[];if(e.length===0){this.showError("You need to own at least one system to send fleets");return}const i=e.map(n=>`<option value="${n.id}">${n.name||`System ${n.id.slice(-3)}`}</option>`).join("");this.showModal("Send Fleet",`
      <form id="fleet-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">From System:</label>
          <select id="from-system" class="w-full p-2 bg-space-700 border border-space-600 rounded">
            ${i}
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">To System:</label>
          <input type="text" id="to-system" value="${t.name||`System ${t.id.slice(-3)}`}"
                 class="w-full p-2 bg-space-700 border border-space-600 rounded" readonly>
          <input type="hidden" id="to-system-id" value="${t.id}">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Fleet Strength:</label>
          <input type="number" id="fleet-strength" min="1" max="100" value="10"
                 class="w-full p-2 bg-space-700 border border-space-600 rounded">
        </div>
        <div class="flex space-x-2">
          <button type="submit" class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-500 rounded">
            Send Fleet
          </button>
          <button type="button" onclick="document.getElementById('modal-overlay').classList.add('hidden')"
                  class="flex-1 px-4 py-2 bg-space-700 hover:bg-space-600 rounded">
            Cancel
          </button>
        </div>
      </form>
    `),document.getElementById("fleet-form").addEventListener("submit",async n=>{n.preventDefault();try{const o=document.getElementById("from-system").value,r=document.getElementById("to-system-id").value,a=parseInt(document.getElementById("fleet-strength").value);await this.gameState.sendFleet(o,r,a),this.hideModal()}catch(o){this.showError(`Failed to send fleet: ${o.message}`)}})}showTradeRouteModal(t){var o;const e=((o=this.gameState)==null?void 0:o.getOwnedSystems())||[];if(e.length===0){this.showError("You need to own at least one system to create trade routes");return}const i=e.map(r=>`<option value="${r.id}">${r.name||`System ${r.id.slice(-3)}`}</option>`).join(""),n=["food","ore","goods","fuel"].map(r=>`<option value="${r}">${r.charAt(0).toUpperCase()+r.slice(1)}</option>`).join("");this.showModal("Create Trade Route",`
      <form id="trade-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">From System:</label>
          <select id="trade-from-system" class="w-full p-2 bg-space-700 border border-space-600 rounded">
            ${i}
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">To System:</label>
          <input type="text" value="${t.name||`System ${t.id.slice(-3)}`}"
                 class="w-full p-2 bg-space-700 border border-space-600 rounded" readonly>
          <input type="hidden" id="trade-to-system-id" value="${t.id}">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Cargo Type:</label>
          <select id="cargo-type" class="w-full p-2 bg-space-700 border border-space-600 rounded">
            ${n}
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Cargo Capacity:</label>
          <input type="number" id="cargo-capacity" min="1" max="1000" value="100"
                 class="w-full p-2 bg-space-700 border border-space-600 rounded">
        </div>
        <div class="flex space-x-2">
          <button type="submit" class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-500 rounded">
            Create Route
          </button>
          <button type="button" onclick="document.getElementById('modal-overlay').classList.add('hidden')"
                  class="flex-1 px-4 py-2 bg-space-700 hover:bg-space-600 rounded">
            Cancel
          </button>
        </div>
      </form>
    `),document.getElementById("trade-form").addEventListener("submit",async r=>{r.preventDefault();try{const a=document.getElementById("trade-from-system").value,l=document.getElementById("trade-to-system-id").value,u=document.getElementById("cargo-type").value,d=parseInt(document.getElementById("cargo-capacity").value);await this.gameState.createTradeRoute(a,l,u,d),this.hideModal()}catch(a){this.showError(`Failed to create trade route: ${a.message}`)}})}showFleetPanel(){var i;const t=((i=this.gameState)==null?void 0:i.getPlayerFleets())||[],e=t.length>0?t.map(s=>`
      <div class="bg-space-700 p-3 rounded mb-2">
        <div class="font-semibold">Fleet ${s.id.slice(-3)}</div>
        <div class="text-sm text-space-300">
          <div>From: ${s.from_name||s.from_id}</div>
          <div>To: ${s.to_name||s.to_id}</div>
          <div>Strength: ${s.strength}</div>
          <div>ETA: ${s.eta_tick?`Tick ${s.eta_tick}`:"Unknown"}</div>
        </div>
      </div>
    `).join(""):'<div class="text-space-400">No fleets in transit</div>';this.showModal("Your Fleets",e)}showTradePanel(){var i;const t=((i=this.gameState)==null?void 0:i.getPlayerTrades())||[],e=t.length>0?t.map(s=>`
      <div class="bg-space-700 p-3 rounded mb-2">
        <div class="font-semibold">Trade Route ${s.id.slice(-3)}</div>
        <div class="text-sm text-space-300">
          <div>From: ${s.from_name||s.from_id}</div>
          <div>To: ${s.to_name||s.to_id}</div>
          <div>Cargo: ${s.cargo}</div>
          <div>Capacity: ${s.cap}</div>
          <div>ETA: ${s.eta_tick?`Tick ${s.eta_tick}`:"Unknown"}</div>
        </div>
      </div>
    `).join(""):'<div class="text-space-400">No active trade routes</div>';this.showModal("Your Trade Routes",e)}showDiplomacyPanel(){this.showModal("Diplomacy",`
      <div class="text-center text-space-400 py-8">
        Diplomacy features coming soon!
      </div>
    `)}showBankingPanel(){var s;const t=((s=this.gameState)==null?void 0:s.getPlayerBanks())||[],e=t.reduce((n,o)=>n+(o.credits_per_tick||0),0),i=t.length>0?t.map(n=>`
      <div class="bg-space-700 p-3 rounded mb-2">
        <div class="font-semibold text-plasma-300">${n.name||`CryptoServer-${n.id.slice(-3)}`}</div>
        <div class="text-sm text-space-300">
          <div>System: ${n.system_name||n.system_id}</div>
          <div>Security Level: ${n.security_level||1}</div>
          <div>Processing Power: ${n.processing_power||10}</div>
          <div class="text-nebula-300">Income: ${n.credits_per_tick||1} credits/tick</div>
          <div class="text-xs ${n.active?"text-green-400":"text-red-400"}">
            ${n.active?"Online":"Offline"}
          </div>
        </div>
      </div>
    `).join(""):'<div class="text-space-400">No crypto servers deployed</div>';this.showModal("Crypto Banking Network",`
      <div class="mb-4">
        <div class="text-lg font-semibold text-plasma-300">Total Income: ${e} credits/tick</div>
        <div class="text-sm text-space-400">${e*6} credits/minute â€¢ ${e*360} credits/hour</div>
      </div>
      <div class="space-y-2">
        ${i}
      </div>
      <div class="mt-4 text-xs text-space-400 border-t border-space-600 pt-2">
        ðŸ’¡ Build Crypto Servers at your systems to generate passive income
      </div>
    `)}}class dt{constructor(){this.mapRenderer=null,this.uiController=null,this.init()}async init(){console.log("Initializing Xan Nation..."),this.uiController=new lt,this.mapRenderer=new ct("game-canvas"),f.subscribe(t=>{this.handleAuthChange(t)}),k.subscribe(t=>{this.handleGameStateChange(t)}),this.setupEventListeners(),console.log("Xan Nation initialized")}handleAuthChange(t){this.uiController.updateAuthUI(t),t?console.log("User logged in:",t.username):console.log("User logged out")}handleGameStateChange(t){this.mapRenderer&&(this.mapRenderer.setSystems(t.systems),this.mapRenderer.setFleets(t.fleets),this.mapRenderer.setSelectedSystem(t.selectedSystem),t.mapData&&t.mapData.lanes&&this.mapRenderer.setLanes(t.mapData.lanes),t.systems.length>0&&!this.mapRenderer.hasInitialFit&&(this.mapRenderer.fitToSystems(),this.mapRenderer.hasInitialFit=!0)),this.uiController.updateGameUI(t)}setupEventListeners(){const t=document.getElementById("game-canvas");t.addEventListener("systemSelected",s=>{k.selectSystem(s.detail.system.id)});const e=document.getElementById("context-menu");e.addEventListener("click",s=>{const n=s.target.dataset.action,o=e.dataset.systemId;n&&o&&(this.handleContextMenuAction(n,o),e.classList.add("hidden"))}),t.addEventListener("mouseleave",()=>{document.getElementById("tooltip").classList.add("hidden")}),document.getElementById("fleet-btn").addEventListener("click",()=>{this.uiController.showFleetPanel()}),document.getElementById("trade-btn").addEventListener("click",()=>{this.uiController.showTradePanel()}),document.getElementById("diplo-btn").addEventListener("click",()=>{this.uiController.showDiplomacyPanel()}),document.getElementById("banking-btn").addEventListener("click",()=>{this.uiController.showBankingPanel()}),document.getElementById("login-btn").addEventListener("click",()=>{this.handleLogin()}),document.getElementById("logout-btn").addEventListener("click",()=>{this.handleLogout()}),document.getElementById("build-btn").addEventListener("click",()=>{this.handleBuildAction()}),document.getElementById("send-fleet-btn").addEventListener("click",()=>{this.handleSendFleetAction()}),document.getElementById("trade-route-btn").addEventListener("click",()=>{this.handleTradeRouteAction()}),document.addEventListener("keydown",s=>{this.handleKeyboardInput(s)});const i=document.getElementById("modal-overlay");i.addEventListener("click",s=>{s.target===i&&this.uiController.hideModal()})}async handleLogin(){try{await f.loginWithDiscord()}catch(t){console.error("Login failed:",t),this.uiController.showError("Login failed. Please try again.")}}handleLogout(){f.logout()}handleContextMenuAction(t,e){const i=k.systems.find(s=>s.id===e);if(i)switch(t){case"view":k.selectSystem(e),this.mapRenderer.centerOnSystem(e);break;case"fleet":this.uiController.showSendFleetModal(i);break;case"trade":this.uiController.showTradeRouteModal(i);break}}handleBuildAction(){const t=k.getSelectedSystem();if(!t){this.uiController.showError("Please select a system first");return}if(!f.isLoggedIn()){this.uiController.showError("Please log in first");return}this.uiController.showBuildModal(t)}handleSendFleetAction(){const t=k.getSelectedSystem();if(!t){this.uiController.showError("Please select a system first");return}if(!f.isLoggedIn()){this.uiController.showError("Please log in first");return}this.uiController.showSendFleetModal(t)}handleTradeRouteAction(){const t=k.getSelectedSystem();if(!t){this.uiController.showError("Please select a system first");return}if(!f.isLoggedIn()){this.uiController.showError("Please log in first");return}this.uiController.showTradeRouteModal(t)}handleKeyboardInput(t){if(!(t.target.tagName==="INPUT"||t.target.tagName==="TEXTAREA"))switch(t.key.toLowerCase()){case"escape":this.uiController.hideModal(),document.getElementById("context-menu").classList.add("hidden");break;case"f":this.handleSendFleetAction();break;case"t":this.handleTradeRouteAction();break;case"b":this.handleBuildAction();break;case"c":k.getSelectedSystem()&&this.mapRenderer.centerOnSystem(k.getSelectedSystem().id);break;case"h":this.mapRenderer.fitToSystems();break}}}new dt;
